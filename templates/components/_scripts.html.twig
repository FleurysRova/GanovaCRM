<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	const App = {
token: localStorage.getItem('zanova_token'),
theme: localStorage.getItem('zanova_theme') || 'dark',
isSidebarCollapsed: localStorage.getItem('sidebar_collapsed') === 'true',
currentRole: localStorage.getItem('zanova_current_role') || 'admin', // 'admin', 'agent' ou 'supervisor'
userData: null,

init() {
this.applyTheme();
this.applySidebarState();
this.bindEvents();
if (this.token) {
this.bootApp();
}
},

bindEvents() {
console.log("App: Binding events...");
const safeBind = (id, event, fn) => {
const el = document.getElementById(id);
if (el) 
el.addEventListener(event, fn);
 else 
console.warn(`App: Element #${id} not found for binding ${event}`);



};

safeBind('btn-login', 'click', () => this.login());
safeBind('btn-logout', 'click', () => this.logout());
safeBind('sidebar-toggle', 'click', () => this.toggleSidebar());
safeBind('mobile-menu-toggle', 'click', () => this.toggleMobileSidebar());

// Navigation
document.querySelectorAll('.nav-item').forEach(item => {
item.addEventListener('click', (e) => {
e.preventDefault();
console.log("App: Navigating to", item.dataset.target);
document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
item.classList.add('active');
this.switchView(item.dataset.target);
const sb = document.getElementById('sidebar');
if (sb) 
sb.classList.remove('mobile-open');



});
});
},

toggleTheme() {
this.theme = this.theme === 'dark' ? 'light' : 'dark';
localStorage.setItem('zanova_theme', this.theme);
this.applyTheme();
},

applyTheme() {
document.documentElement.setAttribute('data-theme', this.theme);
},

toggleSidebar() {
this.isSidebarCollapsed = !this.isSidebarCollapsed;
localStorage.setItem('sidebar_collapsed', this.isSidebarCollapsed);
this.applySidebarState();
},

applySidebarState() {
const sb = document.getElementById('sidebar');
if (this.isSidebarCollapsed) 
sb.classList.add('collapsed');
 else 
sb.classList.remove('collapsed');



},

toggleMobileSidebar() {
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('sidebar-overlay');

sidebar.classList.toggle('mobile-open');
overlay.classList.toggle('active');

if (sidebar.classList.contains('mobile-open')) {
document.body.style.overflow = 'hidden';
} else {
document.body.style.overflow = '';
}
},

async login() {
console.log("App: Login attempt...");
const emailEl = document.getElementById('email');
const passwordEl = document.getElementById('password');
if (! emailEl || ! passwordEl) {
console.error("App: Login fields not found");
return;
}

this.showLoader(true);
const errBox = document.getElementById('auth-error');
if (errBox) 
errBox.classList.add('hidden');



try {
const email = emailEl.value;
const password = passwordEl.value;
console.log("App: Sending request to /api/login_check for", email);

const response = await fetch('/api/login_check', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(
{email, password}
)
});

console.log("App: Response status:", response.status);
const data = await response.json();

if (response.ok) {
console.log("App: Login successful, booting app...");
this.token = data.token;
localStorage.setItem('zanova_token', this.token);
await this.bootApp();
} else {
console.error("App: Login failed:", data.message || "Identifiants invalides");
throw new Error(data.message || "Identifiants invalides");
}
} catch (err) {
console.error("App: Login error:", err);
if (errBox) {
errBox.innerText = err.message;
errBox.classList.remove('hidden');
} else {
alert(err.message);
}
} finally {
this.showLoader(false);
}
},

async bootApp() {
this.showLoader(true);
try {
const response = await fetch('/api/profile', {
headers: {
'Authorization': `Bearer ${
this.token
}`
}
});
if (! response.ok) 
throw new Error("Expulsion");



const result = await response.json();
this.userData = result.data;
this.renderUI();
document.getElementById('auth-screen').classList.add('hidden');
document.getElementById('main-dashboard').classList.remove('hidden');
this.initializeDashboardData();
} catch (err) {
this.logout();
} finally {
this.showLoader(false);
}
},

renderUI() {
document.getElementById('user-name').innerText = `${
this.userData.prenom
} ${
this.userData.nom
}`;
document.getElementById('user-role').innerText = this.userData.role_crm;
document.getElementById('btn-switch-role').style.display = 'flex';

const modeIndicator = document.getElementById('mode-indicator');
const modeText = document.getElementById('mode-text');
if (modeIndicator && modeText) {
modeIndicator.style.display = 'flex';
modeIndicator.className = 'mode-indicator ' + (
this.currentRole === 'admin' ? 'admin' : (this.currentRole === 'agent' ? 'agent' : 'supervisor')
);
modeText.innerText = this.currentRole === 'admin' ? 'Mode Admin' : (this.currentRole === 'agent' ? 'Mode Agent' : 'Mode Superviseur');
}

if (this.userData.roles.includes('ROLE_RESPONSABLE')) {
document.querySelectorAll('.restricted-responsable').forEach(el => el.classList.remove('hidden'));
}

if (this.currentRole === 'agent') {
this.applyAgentView();
} else if (this.currentRole === 'supervisor') {
this.applySupervisorView();
}
},

switchView(target) {
const titles = {
'dashboard': this.currentRole === 'agent' ? 'Mon Espace Agent' : (this.currentRole === 'supervisor' ? 'Supervision' : 'Tableau de bord'),
'statistics': 'Statistiques & Analyse',
'campaigns': 'Campagnes',
'users': '√âquipe & Acc√®s',
'contacts': 'R√©pertoire Contacts'
};

document.getElementById('page-title').innerText = titles[target] || target.charAt(0).toUpperCase() + target.slice(1);
document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));

const viewMapping = {
'dashboard': this.currentRole === 'agent' ? 'agent-overview-view' : (this.currentRole === 'supervisor' ? 'supervisor-overview-view' : 'overview-view'),
'statistics': 'statistics-view',
'campaigns': 'campaigns-view',
'users': 'users-view',
'contacts': 'contacts-view'
};

const activeView = document.getElementById(viewMapping[target] || target + '-view');
if (activeView) {
activeView.classList.remove('hidden');
document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
document.querySelector(`[onclick="App.switchView('${target}')"]`) ?. classList.add('active');

if (target === 'dashboard') {
if (this.currentRole === 'agent') 
this.initializeAgentDashboard();
 else if (this.currentRole === 'supervisor') 
this.initializeSupervisorDashboard();
 else 
this.initializeDashboardData();



} else if (target === 'statistics') 
this.initializeStatistics();
 else if (target === 'campaigns') 
this.loadCampaigns();
 else if (target === 'users') 
this.loadUsers();
 else if (target === 'contacts') 
this.loadContacts();



}
},

async loadGlobalContacts() {
this.showLoader(true);
try {
const res = await fetch('/api/management/campaigns', {
headers: {
'Authorization': `Bearer ${
this.token
}`
}
});
const campaigns = await res.json();
const container = document.getElementById('contact-campaign-selector');
container.innerHTML = campaigns.map(c => `
                    <div onclick="App.loadCampaignContacts(${
c.id
})" class="activity-item" style="cursor:pointer; transition:0.2s;">
                        <strong>${
c.nom
}</strong>
                    </div>
                `).join('');
} catch (err) {
console.error(err);
} finally {
this.showLoader(false);
}
},

async loadCampaignContacts(campaignId) {
this.showLoader(true);
try {
const res = await fetch(`/api/management/campaigns/${campaignId}/contacts`, {
headers: {
'Authorization': `Bearer ${
this.token
}`
}
});
const contacts = await res.json();
const tbody = document.getElementById('contact-list-body');

tbody.innerHTML = contacts.length ? contacts.map(c => `
                    <tr>
                        <td><strong>${
c.nom
}</strong><br><small style="color:var(--text-dim)">ID: ${
c.id
}</small></td>
                        <td>${
c.telephone
}<br><small>${
c.email || '-'
}</small></td>
                        <td><span class="badge badge-neutral">${
c.source
}</span></td>
                        <td><span class="badge ${
c.status === 'nouveau' ? 'badge-primary' : 'badge-success'
}">${
c.status
}</span></td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align:center; padding:2rem;">Aucun contact dans cette campagne.</td></tr>';
} catch (err) {
alert(err.message);
} finally {
this.showLoader(false);
}
},

async loadCampaigns() {
this.showLoader(true);
try {
const res = await fetch('/api/management/campaigns?t=' + Date.now(), {
method: 'GET',
cache: 'no-store',
headers: {
'Authorization': `Bearer ${
this.token
}`,
'Accept': 'application/json'
}
});
const data = await res.json();
if (!Array.isArray(data)) 
throw new Error(data.message || "R√©ponse invalide du serveur");



const tbody = document.getElementById('campaign-list-body');
tbody.innerHTML = data.length ? data.map(c => `
                    <tr>
                        <td><strong>${
c.nom
}</strong><br><small style="color:var(--text-dim)">ID: ${
c.id
}</small></td>
                        <td>${
c.date_debut || '-'
} / ${
c.date_fin || '-'
}</td>
                        <td>${
c.responsable || 'Non assign√©'
}</td>
                        <td><span class='badge'>${
c.contacts_count
}</span></td>
                        <td>
                            <div class="action-btns">
                                <button onclick="UI.manageAssignments(${
c.id
})" class="btn-action" title="Affectations">ü§ù</button>
                                <button onclick="UI.manageFields(${
c.id
})" class="btn-action" title="Formulaire">üìã</button>
                                <button onclick="UI.editCampaign(${
c.id
})" class="btn-action">‚úèÔ∏è</button>
                                <button onclick="UI.deleteCampaign(${
c.id
})" class="btn-action delete">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="5" style="text-align:center; padding: 2rem;">Aucune campagne trouv√©e</td></tr>';
} catch (err) {
alert("Erreur: " + err.message);
} finally {
this.showLoader(false);
}
},

async loadUsers() {
this.showLoader(true);
try {
const res = await fetch('/api/management/users?t=' + Date.now(), {
method: 'GET',
cache: 'no-store',
headers: {
'Authorization': `Bearer ${
this.token
}`,
'Accept': 'application/json'
}
});
const data = await res.json();
if (!Array.isArray(data)) 
throw new Error(data.message || "R√©ponse invalide du serveur");



const tbody = document.getElementById('user-list-body');
tbody.innerHTML = data.map(u => {
const roleClass = u.role === 'responsable' ? 'badge-admin' : (u.role === 'superviseur' ? 'badge-primary' : 'badge-neutral');
const statusClass = u.status === 'active' ? 'badge-success' : 'badge-danger';
return `
                        <tr>
                            <td><div style="display:flex; align-items:center; gap:12px;">
                                <div class="user-avatar" style="width:32px; height:32px; font-size:0.8rem;">${
u.prenom[0]
}</div>
                                <strong>${
u.prenom
} ${
u.nom
}</strong>
                            </div></td>
                            <td><span style="color:var(--text-dim); font-size:0.9rem;">${
u.email
}</span></td>
                            <td><span class="badge ${roleClass}">${
u.role
}</span></td>
                            <td><span class="badge ${statusClass}">${
u.status
}</span></td>
                            <td>
                                <div class="action-btns">
                                    <button onclick="UI.editUser(${
u.id
})" class="btn-action">‚úèÔ∏è</button>
                                    <button onclick="UI.deleteUser(${
u.id
})" class="btn-action delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
}).join('');
} catch (err) {
alert("Erreur: " + err.message);
} finally {
this.showLoader(false);
}
},

showLoader(show) {
document.getElementById('global-loader').classList.toggle('hidden', !show);
},

addActivity(msg) {
const container = document.getElementById('activity-log');
if (! container) 
return;



const empty = container.querySelector('.empty');
if (empty) 
empty.remove();



const item = document.createElement('div');
item.className = 'activity-item';
const now = new Date();
const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
item.innerHTML = `<span class="time">${timeStr}</span> <p class="msg">${msg}</p>`;
container.prepend(item);
},

updateAgentRanking(criteria) {
this.simulateAgentRanking(criteria);
},

simulateAgentRanking(criteria) {
const rankingData = {
calls: [
{
name: 'Martin Dubois',
stats: '45 appels ‚Ä¢ 92% qualification',
score: 45,
avatar: 'MD',
color: 'primary'
}, {
name: 'Sophie Laurent',
stats: '38 appels ‚Ä¢ 88% qualification',
score: 38,
avatar: 'SL',
color: 'success'
}, {
name: 'Thomas Bernard',
stats: '32 appels ‚Ä¢ 85% qualification',
score: 32,
avatar: 'TB',
color: 'info'
}
],
duration: [
{
name: 'Sophie Laurent',
stats: '38 appels ‚Ä¢ 3:45 moyenne',
score: '3:45',
avatar: 'SL',
color: 'success'
}, {
name: 'Martin Dubois',
stats: '45 appels ‚Ä¢ 3:20 moyenne',
score: '3:20',
avatar: 'MD',
color: 'primary'
}, {
name: 'Thomas Bernard',
stats: '32 appels ‚Ä¢ 2:55 moyenne',
score: '2:55',
avatar: 'TB',
color: 'info'
}
],
qualification: [
{
name: 'Martin Dubois',
stats: '45 appels ‚Ä¢ 92% qualification',
score: '92%',
avatar: 'MD',
color: 'primary'
}, {
name: 'Sophie Laurent',
stats: '38 appels ‚Ä¢ 88% qualification',
score: '88%',
avatar: 'SL',
color: 'success'
}, {
name: 'Thomas Bernard',
stats: '32 appels ‚Ä¢ 85% qualification',
score: '85%',
avatar: 'TB',
color: 'info'
}
]
};
const data = rankingData[criteria] || rankingData.calls;
const container = document.getElementById('top-agents');
if (! container) 
return;



container.innerHTML = data.map((agent, index) => `
                <div class="d-flex align-items-center p-3 mb-2 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-200">
                    <div class="badge bg-${
agent.color
} text-white rounded-circle p-2 me-3">
                        <span class="fw-bold">${
index + 1
}</span>
                    </div>
                    <div class="avatar bg-${
agent.color
} bg-opacity-10 text-${
agent.color
} rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <span class="fw-bold">${
agent.avatar
}</span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-semibold text-gray-800 dark:text-gray-200">${
agent.name
}</h6>
                        <small class="text-gray-500 dark:text-gray-400">${
agent.stats
}</small>
                    </div>
                    <div class="text-end">
                        <div class="h5 mb-0 fw-bold text-${
agent.color
}">${
agent.score
}</div>
                    </div>
                </div>
            `).join('');
},

filterActivity(type) {
document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
if (event.target.classList) 
event.target.classList.add('active');



this.filterActivitiesByType(type);
},

filterActivitiesByType(type) {
const activities = {
all: [
{
icon: 'fa-phone',
type: 'call',
title: 'Appel termin√© - Agent 1',
details: 'Contact: +33612345678 ‚Ä¢ Dur√©e: 3:45',
time: 'Il y a 2 min',
alert: false,
color: 'primary'
}, {
icon: 'fa-check-circle',
type: 'qualification',
title: 'Qualification - Agent 2',
details: 'Statut: Accept√© ‚Ä¢ Campagne: Vente 2024',
time: 'Il y a 5 min',
alert: false,
color: 'success'
}, {
icon: 'fa-exclamation-triangle',
type: 'alert',
title: 'Alerte - Agent 3',
details: 'Appel d√©passe dur√©e maximale (10 min)',
time: 'Il y a 8 min',
alert: true,
color: 'danger'
}
],
calls: [
{
icon: 'fa-phone',
type: 'call',
title: 'Appel termin√© - Agent 1',
details: 'Contact: +33612345678 ‚Ä¢ Dur√©e: 3:45',
time: 'Il y a 2 min',
alert: false,
color: 'primary'
}, {
icon: 'fa-phone',
type: 'call',
title: 'Appel termin√© - Agent 2',
details: 'Contact: +33698765432 ‚Ä¢ Dur√©e: 2:15',
time: 'Il y a 12 min',
alert: false,
color: 'primary'
}
],
qualifications: [
{
icon: 'fa-check-circle',
type: 'qualification',
title: 'Qualification - Agent 2',
details: 'Statut: Accept√© ‚Ä¢ Campagne: Vente 2024',
time: 'Il y a 5 min',
alert: false,
color: 'success'
}, {
icon: 'fa-times-circle',
type: 'qualification',
title: 'Qualification - Agent 1',
details: 'Statut: Refus√© ‚Ä¢ Campagne: Satisfaction',
time: 'Il y a 18 min',
alert: false,
color: 'danger'
}
]
};
const container = document.getElementById('activity-log');
if (! container) 
return;



const data = activities[type] || activities.all;
container.innerHTML = data.map(activity => `
                <div class="d-flex align-items-start p-3 mb-2 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-200 ${
activity.alert ? 'border border-' + activity.color + '-200' : ''
}">
                    <div class="icon-box bg-${
activity.color
} bg-opacity-10 text-${
activity.color
} rounded-lg p-2 me-3">
                        <i class="fas ${
activity.icon
}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-semibold text-gray-800 dark:text-gray-200">${
activity.title
}</h6>
                        <small class="text-gray-500 dark:text-gray-400">${
activity.details
}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-gray-400 dark:text-gray-500">${
activity.time
}</small>
                    </div>
                </div>
            `).join('');
},

refreshCampaigns() {
this.simulateCampaignRefresh();
},

simulateCampaignRefresh() {
const campaigns = [
{
name: 'Vente Q1 2024',
stats: '48% ‚Ä¢ 125/250 contacts',
progress: 48,
color: 'primary'
}, {
name: 'Satisfaction Client',
stats: '82% ‚Ä¢ 95/114 contacts',
progress: 82,
color: 'success'
}, {
name: 'Prospection Printemps',
stats: '23% ‚Ä¢ 45/195 contacts',
progress: 23,
color: 'warning'
}
];
const container = document.getElementById('active-campaigns');
if (! container) 
return;



container.innerHTML = campaigns.map(campaign => `
                <div class="p-3 mb-3 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-200">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 fw-semibold text-gray-800 dark:text-gray-200">${
campaign.name
}</h6>
                        <span class="badge bg-${
campaign.color
} bg-opacity-10 text-${
campaign.color
}">${
campaign.progress
}%</span>
                    </div>
                    <small class="text-gray-500 dark:text-gray-400 d-block mb-2">${
campaign.stats
}</small>
                    <div class="progress bg-gray-200 dark:bg-gray-600 h-2 rounded">
                        <div class="progress-bar bg-${
campaign.color
}" style="width: ${
campaign.progress
}%"></div>
                    </div>
                </div>
            `).join('');
if (event && event.target) {
const btn = event.target.closest('button') || event.target;
const icon = btn.querySelector('i');
if (icon) {
icon.classList.add('fa-spin');
setTimeout(() => icon.classList.remove('fa-spin'), 500);
}
}
},

refreshSupervision() {
this.loadSupervisorRealtime();
this.loadSupervisorAlerts();
},

initializeSupervisionData() {
const agents = [
{
name: 'Agent 1',
status: 'available',
duration: '00:00',
callStatus: 'En attente',
alert: false
}, {
name: 'Agent 2',
status: 'in-call',
duration: '02:45',
callStatus: 'En cours',
alert: false
}, {
name: 'Agent 3',
status: 'in-call',
duration: '08:30',
callStatus: 'D√©passement',
alert: true
}
];
const container = document.getElementById('realtime-supervision');
if (! container) 
return;



container.innerHTML = agents.map((agent, index) => `
                <div class="d-flex align-items-center p-3 mb-2 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-200 ${
agent.alert ? 'border border-danger' : ''
}">
                    <div class="avatar bg-${
agent.status === 'in-call' ? 'success' : 'primary'
} bg-opacity-10 text-${
agent.status === 'in-call' ? 'success' : 'primary'
} rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <span class="fw-bold">${
String.fromCharCode(65 + index)
}</span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-semibold text-gray-800 dark:text-gray-200">${
agent.name
}</h6>
                        <span class="badge bg-${
agent.status === 'in-call' ? 'success' : 'primary'
} bg-opacity-10 text-${
agent.status === 'in-call' ? 'success' : 'primary'
}">
                            ${
agent.status === 'in-call' ? 'En appel' : 'Disponible'
}
                        </span>
                    </div>
                    <div class="text-end">
                        <div class="h6 mb-0 fw-bold ${
agent.alert ? 'text-danger' : 'text-gray-800 dark:text-gray-200'
}">${
agent.duration
}</div>
                        <small class="${
agent.alert ? 'text-danger' : 'text-gray-500 dark:text-gray-400'
}">${
agent.callStatus
}</small>
                    </div>
                </div>
            `).join('');
},

initializeStatistics() {
const filter = document.getElementById('time-filter');
if (filter) {
filter.addEventListener('change', (e) => {
if (e.target.value === 'custom') 
document.getElementById('custom-date-filter').classList.remove('hidden');
 else {
document.getElementById('custom-date-filter').classList.add('hidden');
this.loadStatisticsData(e.target.value);
}
});
}
this.loadStatisticsData('week');
this.initializeCharts();
this.renderRoleSpecificStats();
},

loadStatisticsData(period) {
const mockData = {
today: {
totalCalls: 45,
avgDuration: '3:25',
conversion: 12,
quality: 85
},
week: {
totalCalls: 287,
avgDuration: '4:12',
conversion: 18,
quality: 88
},
month: {
totalCalls: 1245,
avgDuration: '3:58',
conversion: 15,
quality: 86
}
};
const data = mockData[period] || mockData.week;
this.animateCounter('stat-total-calls', data.totalCalls);
const durationEl = document.getElementById('stat-avg-duration');
if (durationEl) 
durationEl.textContent = data.avgDuration;



this.animateCounter('stat-conversion', data.conversion, '%');
this.animateCounter('stat-quality', data.quality, '/100');
this.updateCharts(period);
},

initializeCharts() {
const callsEl = document.getElementById('calls-chart');
if (callsEl) {
const callsCtx = callsEl.getContext('2d');
this.callsChart = new Chart(callsCtx, {
type: 'line',
data: {
labels: [
'Lun',
'Mar',
'Mer',
'Jeu',
'Ven',
'Sam',
'Dim'
],
datasets: [
{
label: 'Appels r√©ussis',
data: [
65,
78,
90,
81,
96,
85,
70
],
borderColor: 'rgb(59, 130, 246)',
backgroundColor: 'rgba(59, 130, 246, 0.1)',
tension: 0.4
}, {
label: 'Appels manqu√©s',
data: [
28,
32,
25,
30,
22,
28,
35
],
borderColor: 'rgb(239, 68, 68)',
backgroundColor: 'rgba(239, 68, 68, 0.1)',
tension: 0.4
}
]
},
options: {
responsive: true,
maintainAspectRatio: false
}
});
}
const statusEl = document.getElementById('status-chart');
if (statusEl) {
const statusCtx = statusEl.getContext('2d');
this.statusChart = new Chart(statusCtx, {
type: 'doughnut',
data: {
labels: [
'R√©ussis', 'Manqu√©s', 'En cours', 'Qualifi√©s'
],
datasets: [
{
data: [
287, 95, 23, 156
],
backgroundColor: [
'rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(99, 102, 241, 0.8)'
],
borderWidth: 0
}
]
},
options: {
responsive: true,
maintainAspectRatio: false
}
});
}
},

updateCharts(period) {
const chartData = {
today: {
calls: [
45,
38,
52,
41,
48,
35,
28
],
missed: [
12,
15,
8,
18,
10,
14,
20
]
},
week: {
calls: [
65,
78,
90,
81,
96,
85,
70
],
missed: [
28,
32,
25,
30,
22,
28,
35
]
},
month: {
calls: [
125,
145,
160,
138,
175,
165,
140
],
missed: [
55,
62,
48,
58,
42,
52,
65
]
}
};
if (this.callsChart && chartData[period]) {
this.callsChart.data.datasets[0].data = chartData[period].calls;
this.callsChart.data.datasets[1].data = chartData[period].missed;
this.callsChart.update();
}
},

renderRoleSpecificStats() {
const container = document.getElementById('role-specific-stats');
if (! container) 
return;



const userRole = this.userData ?. role_crm || 'agent';
let content = '';
switch (userRole) {
case 'responsable': content = this.renderResponsableStats();
break;
case 'superviseur': content = this.renderSuperviseurStats();
break;
case 'agent': content = this.renderAgentStats();
break;
default: content = '<div class="alert alert-warning">R√¥le non reconnu</div>';
}
container.innerHTML = content;
},

renderResponsableStats() {
return `
                <div class="row g-4">
                    <div class="col-xl-6">
                        <div class="card bg-white dark:bg-gray-800 border-0 shadow-lg rounded-2xl">
                            <div class="card-header bg-transparent border-gray-100 dark:border-gray-700 px-4 py-3">
                                <h5 class="card-title mb-0 fw-bold text-gray-800 dark:text-gray-100"><i class="fas fa-bullseye text-primary me-2"></i>Performance par Campagne</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead><tr><th>Campagne</th><th>Appels</th><th>Conversion</th><th>Score</th></tr></thead>
                                        <tbody>
                                            <tr><td><strong>Vente Q1</strong></td><td>245</td><td><span class="badge bg-success">22%</span></td><td><span class="badge bg-primary">87/100</span></td></tr>
                                            <tr><td><strong>Satisfaction</strong></td><td>189</td><td><span class="badge bg-warning">15%</span></td><td><span class="badge bg-info">82/100</span></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="card bg-white dark:bg-gray-800 border-0 shadow-lg rounded-2xl">
                            <div class="card-header bg-transparent border-gray-100 dark:border-gray-700 px-4 py-3">
                                <h5 class="card-title mb-0 fw-bold text-gray-800 dark:text-gray-100"><i class="fas fa-trophy text-warning me-2"></i>Classement des Agents</h5>
                            </div>
                            <div class="card-body p-4">${
this.renderTopAgentsList()
}</div>
                        </div>
                    </div>
                </div>
            `;
},

renderSuperviseurStats() {
return `<div class="row g-4"><div class="col-12"><div class="card bg-white dark:bg-gray-800 border-0 shadow-lg rounded-2xl"><div class="card-header bg-transparent border-gray-100 dark:border-gray-700 px-4 py-3"><h5 class="card-title mb-0 fw-bold text-gray-800 dark:text-gray-100"><i class="fas fa-chart-line text-info me-2"></i>Campagne: Vente Q1 2024</h5></div><div class="card-body p-4"><div class="row g-4"><div class="col-md-3 text-center"><h4 class="fw-bold text-primary">245</h4><small class="text-gray-500">Total Appels</small></div><div class="col-md-3 text-center"><h4 class="fw-bold text-success">22%</h4><small class="text-gray-500">Taux Conversion</small></div></div></div></div></div></div>`;
},

renderAgentStats() {
return `<div class="row g-4"><div class="col-12"><div class="card bg-white dark:bg-gray-800 border-0 shadow-lg rounded-2xl"><div class="card-header bg-transparent border-gray-100 dark:border-gray-700 px-4 py-3"><h5 class="card-title mb-0 fw-bold text-gray-800 dark:text-gray-100"><i class="fas fa-user text-primary me-2"></i>Mes Performances</h5></div><div class="card-body p-4"><div class="row g-4"><div class="col-md-6"><h6 class="text-gray-600 dark:text-gray-400 mb-3">Aujourd'hui</h6><div class="d-flex justify-content-between"><span>Appels</span><strong>12</strong></div></div></div></div></div></div></div>`;
},

renderTopAgentsList() {
const agents = [
{
name: 'Martin Dubois',
calls: 45,
score: 92,
rank: 1
}, {
name: 'Sophie Laurent',
calls: 38,
score: 88,
rank: 2
}
];
return agents.map(agent => `<div class="d-flex align-items-center p-3 mb-2 bg-gray-50 dark:bg-gray-700 rounded-xl"><div class="badge bg-primary text-white rounded-circle p-2 me-3">${
agent.rank
}</div><div class="flex-grow-1"><h6 class="mb-1 fw-semibold">${
agent.name
}</h6><small class="text-gray-500">${
agent.calls
} appels</small></div><div class="text-end"><div class="h6 mb-0 fw-bold text-primary">${
agent.score
}/100</div></div></div>`).join('');
},

renderAgentsByCampaign() {
const agents = [{
name: 'Agent 1',
calls: 45,
conversion: 20,
status: 'online'
}];
return `<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Agent</th><th>Appels</th><th>Conversion</th><th>Statut</th></tr></thead><tbody>${
agents.map(agent => `<tr><td>${
agent.name
}</td><td>${
agent.calls
}</td><td><span class="badge bg-success">${
agent.conversion
}%</span></td><td><span class="badge bg-success">En ligne</span></td></tr>`).join('')
}</tbody></table></div>`;
},

refreshStatistics() {
const period = document.getElementById('time-filter').value;
this.loadStatisticsData(period);
if (event) {
const btn = event.target.closest('button');
const icon = btn.querySelector('i');
if (icon) {
icon.classList.add('fa-spin');
setTimeout(() => icon.classList.remove('fa-spin'), 500);
}
}
},

applyCustomDateFilter() {
const start = document.getElementById('start-date').value;
const end = document.getElementById('end-date').value;
if (start && end) 
this.loadStatisticsData('custom');
 else 
alert('Veuillez s√©lectionner une date de d√©but et de fin');



},

initializeDashboardData() {
setTimeout(() => {
this.animateCounter('stat-campaigns', 3);
this.animateCounter('stat-agents', 12);
this.animateCounter('stat-calls', 127);
this.animateCounter('stat-qualification', 89, '%');
const cp = document.getElementById('campaigns-progress');
if (cp) 
cp.textContent = '51% de progression';



const as = document.getElementById('agents-status');
if (as) 
as.textContent = '8 en appel / 4 disponible';



this.animateProgressBar('campaigns-progress-bar', 51);
this.animateProgressBar('agents-progress-bar', 67);
}, 1000);
this.simulateAgentRanking('calls');
this.initializeSupervisionData();
this.startRealtimeSupervision();
},

animateCounter(elementId, target, suffix = '') {
const element = document.getElementById(elementId);
if (! element) 
return;



let current = 0;
const increment = target / 50;
const timer = setInterval(() => {
current += increment;
if (current >= target) {
current = target;
clearInterval(timer);
}
element.textContent = Math.floor(current) + suffix;
}, 30);
},

animateProgressBar(elementId, targetWidth) {
const element = document.getElementById(elementId);
if (! element) 
return;



setTimeout(() => {
element.style.width = targetWidth + '%';
element.style.transition = 'width 1.5s ease-out';
}, 500);
},

startRealtimeSupervision() {
setInterval(() => this.updateSupervisionData(), 5000);
},

updateSupervisionData() {
document.querySelectorAll('.supervision-item').forEach((item, index) => {
const durationElement = item.querySelector('.call-duration');
if (durationElement && ! durationElement.classList.contains('warning')) {
const currentTime = durationElement.textContent;
const [m, s] = currentTime.split(':').map(Number);
const total = m * 60 + s + 5;
durationElement.textContent = `${
Math.floor(total / 60).toString().padStart(2, '0')
}:${
(total % 60).toString().padStart(2, '0')
}`;
if (total > 600) {
durationElement.classList.add('warning');
item.classList.add('alert-long-call');
}
}
});
},

logout() {
localStorage.removeItem('zanova_token');
localStorage.removeItem('zanova_current_role');
location.reload();
},

switchUserRole() {
if (this.currentRole === 'admin') 
this.currentRole = 'agent';
 else if (this.currentRole === 'agent') 
this.currentRole = 'supervisor';
 else 
this.currentRole = 'admin';



localStorage.setItem('zanova_current_role', this.currentRole);
document.getElementById('user-role').innerText = this.currentRole === 'agent' ? 'Agent' : (this.currentRole === 'supervisor' ? 'Superviseur' : 'Admin');
const mi = document.getElementById('mode-indicator');
const mt = document.getElementById('mode-text');
if (mi && mt) {
mi.className = 'mode-indicator ' + this.currentRole;
mt.innerText = 'Mode ' + this.currentRole.charAt(0).toUpperCase() + this.currentRole.slice(1);
}
if (this.currentRole === 'agent') 
this.applyAgentView();
 else if (this.currentRole === 'supervisor') 
this.applySupervisorView();
 else 
this.applyAdminView();



this.switchView('dashboard');
},

applySupervisorView() {
document.querySelectorAll('.restricted-responsable').forEach(el => el.classList.add('hidden'));
document.querySelectorAll('.nav-item').forEach(item => {
const oc = item.getAttribute('onclick');
if (oc && oc.includes('users')) 
item.style.display = 'none';
 else 
item.style.display = 'flex';



});
},

initializeSupervisorDashboard() {
setTimeout(() => {
this.loadSupervisorRealtime();
this.loadSupervisorAlerts();
this.loadSupervisorRanking();
this.loadQualificationStats();
this.loadSupervisorCampaigns();
}, 500);
},

loadSupervisorRealtime() {
const agents = [{
name: 'Martin Dubois',
status: 'en_appel',
duration: '3m45s',
qualification: 'en_attente',
campaign: 'Vente Printemps',
alert: true
}];
const container = document.getElementById('supervisor-realtime');
if (! container) 
return;



container.innerHTML = agents.map(agent => `<div class="supervision-item d-flex align-items-center p-3 border rounded mb-2 ${
agent.alert ? 'border-warning bg-warning-50' : ''
}"><div class="agent-avatar me-3">${
agent.name[0]
}</div><div class="flex-1"><h6 class="mb-0">${
agent.name
}</h6><span class="badge ${
agent.status === 'en_appel' ? 'bg-success' : 'bg-secondary'
}">${
agent.status
}</span></div></div>`).join('');
},

loadSupervisorAlerts() {
const alerts = [{
type: 'danger',
message: 'D√©passement dur√©e',
agent: 'Martin Dubois',
time: '2m'
}];
const container = document.getElementById('supervisor-alerts');
if (! container) 
return;



document.getElementById('supervisor-alert-count').innerText = alerts.length;
container.innerHTML = alerts.map(a => `<div class="alert-item p-2 mb-2 border rounded bg-${
a.type
}-50"><p class="small mb-0">${
a.message
}</p></div>`).join('');
},

loadSupervisorRanking() {
const ranking = [{
name: 'Martin Dubois',
stats: '45 appels',
score: 45,
avatar: 'MD',
color: 'primary'
}];
const container = document.getElementById('supervisor-top-agents');
if (! container) 
return;



container.innerHTML = ranking.map(a => `<div class="ranking-item d-flex p-2 border rounded mb-2"><div class="agent-avatar me-2">${
a.avatar
}</div><div class="flex-1"><h6>${
a.name
}</h6></div></div>`).join('');
},

loadQualificationStats() {
const canvas = document.getElementById('qualification-chart');
if (! canvas) 
return;



new Chart(canvas.getContext('2d'), {
type: 'line',
data: {
labels: [
'L',
'M',
'M',
'J',
'V',
'S',
'D'
],
datasets: [
{
data: [
85,
88,
82,
90,
87,
92,
86
],
borderColor: '#3b82f6'
}
]
},
options: {
responsive: true,
maintainAspectRatio: false
}
});
},

loadSupervisorCampaigns() {
const campaigns = [{
name: 'Vente Printemps',
progress: 75,
agents: 5,
status: 'active'
}];
const container = document.getElementById('supervisor-campaigns');
if (! container) 
return;



container.innerHTML = campaigns.map(c => `<div class="campaign-card p-3 border rounded mb-2"><h6>${
c.name
}</h6><div class="progress h-2 mb-2"><div class="progress-bar" style="width:${
c.progress
}%"></div></div></div>`).join('');
},

applyAgentView() {
document.querySelectorAll('.restricted-responsable').forEach(el => el.classList.add('hidden'));
document.querySelectorAll('.nav-item').forEach(item => {
const oc = item.getAttribute('onclick');
if (oc && (oc.includes('users') || oc.includes('campaigns'))) 
item.style.display = 'none';
 else 
item.style.display = 'flex';



});
},

applyAdminView() {
if (this.userData.roles.includes('ROLE_RESPONSABLE')) 
document.querySelectorAll('.restricted-responsable').forEach(el => el.classList.remove('hidden'));



document.querySelectorAll('.nav-item').forEach(item => item.style.display = 'flex');
},

initializeAgentDashboard() {
setTimeout(() => {
this.animateCounter('agent-stat-calls', 42);
this.animateCounter('agent-stat-qualification', 87, '%');
const cp = document.getElementById('agent-calls-progress-bar');
if (cp) 
cp.style.width = '70%';



this.loadAgentCampaigns();
this.loadAgentActivity();
this.loadAgentAlerts();
}, 500);
},

loadAgentCampaigns() {
const campaigns = [{
name: 'Vente Printemps',
progress: 65,
calls: 125
}];
const container = document.getElementById('agent-campaigns');
if (! container) 
return;



container.innerHTML = campaigns.map(c => `<div class="campaign-card p-3 border rounded mb-2"><h6>${
c.name
}</h6><div class="progress h-2"><div class="progress-bar" style="width:${
c.progress
}%"></div></div></div>`).join('');
},

loadAgentActivity() {
const acts = [{
title: 'Appel termin√©',
details: '3m45s',
color: 'primary'
}];
const container = document.getElementById('agent-activity-log');
if (! container) 
return;



container.innerHTML = acts.map(a => `<div class="activity-item p-2 mb-2 border rounded"><h6>${
a.title
}</h6><small>${
a.details
}</small></div>`).join('');
},

loadAgentAlerts() {
const alerts = [{
type: 'warning',
message: 'Qualification requise',
time: '1 min'
}];
const container = document.getElementById('agent-alerts');
if (! container) 
return;



document.getElementById('alert-count').innerText = alerts.length;
container.innerHTML = alerts.map(a => `<div class="alert-item p-2 mb-2 border rounded bg-${
a.type
}-50"><p class="small mb-0">${
a.message
}</p></div>`).join('');
},

launchNextCall() {
const nc = document.getElementById('next-call');
if (! nc) 
return;



nc.innerHTML = `<div class="text-center py-3"><i class="fas fa-phone-volume text-success mb-3 animate-pulse"></i><h6>Appel en cours...</h6><button class="btn btn-danger w-100" onclick="App.endCall()">Terminer</button></div>`;
},

endCall() {
const nc = document.getElementById('next-call');
if (! nc) 
return;



nc.innerHTML = `<div class="text-center py-3"><h6>Qualification requise</h6><select class="form-select mb-2"><option>Accept√©</option><option>Refus√©</option></select><button class="btn-glow w-100" onclick="App.submitQualification()">Soumettre</button></div>`;
},

submitQualification() {
this.loadAgentActivity();
const nc = document.getElementById('next-call');
if (nc) 
nc.innerHTML = `<div class="text-center py-3"><h6>Pr√™t √† appeler</h6><button class="btn-glow w-100" onclick="App.launchNextCall()">Lancer l'appel</button></div>`;



}
};

const UI = {
async deleteCampaign(id) {
if (!confirm("Supprimer ?")) 
return;



App.showLoader(true);
try {
const res = await fetch(`/api/management/campaigns/${id}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
if (res.ok) {
App.addActivity("Campagne supprim√©e");
App.loadCampaigns();
}
} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async editCampaign(id) {
App.showLoader(true);
try {
const res = await fetch('/api/management/campaigns?t=' + Date.now(), {
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
const camps = await res.json();
const camp = camps.find(c => c.id === parseInt(id));
if (camp) 
this.showCampaignModal(camp);



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

showCampaignModal(data = null) {
const c = document.getElementById('modal-container');
document.getElementById('modal-title').innerText = data ? "Modifier" : "Cr√©er";
document.getElementById('modal-body').innerHTML = `<input type="hidden" id="m-camp-id" value="${
data ? data.id : ''
}"><div class="input-group"><label>Titre</label><input type="text" id="m-camp-nom" value="${
data ? data.nom : ''
}"></div><div class="input-group"><label>Dates</label><input type="date" id="m-camp-start" value="${
data ? data.date_debut : ''
}"><input type="date" id="m-camp-end" value="${
data ? data.date_fin : ''
}"></div>`;
const s = document.getElementById('modal-save');
s.innerText = "Enregistrer";
s.onclick = () => this.saveCampaign(data ? 'PUT' : 'POST');
c.classList.remove('hidden');
},

async saveCampaign(method) {
const payload = {
nom: document.getElementById('m-camp-nom').value,
date_debut: document.getElementById('m-camp-start').value,
date_fin: document.getElementById('m-camp-end').value
};
const id = document.getElementById('m-camp-id').value;
const url = method === 'PUT' ? `/api/management/campaigns/${id}` : '/api/management/campaigns';
App.showLoader(true);
try {
const res = await fetch(url, {
method,
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${
App.token
}`
},
body: JSON.stringify(payload)
});
if (res.ok) {
this.closeModal();
App.loadCampaigns();
}
} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

closeModal() {
document.getElementById('modal-container').classList.add('hidden');
},

showUserModal(data = null) {
const c = document.getElementById('modal-container');
document.getElementById('modal-title').innerText = data ? "Modifier" : "Ajouter";
document.getElementById('modal-body').innerHTML = `<input type="hidden" id="m-user-id" value="${
data ? data.id : ''
}"><input type="text" id="m-user-prenom" value="${
data ? data.prenom : ''
}"><input type="text" id="m-user-email" value="${
data ? data.email : ''
}"><select id="m-user-role" class="modal-select"><option value="agent">Agent</option><option value="superviseur">Superviseur</option><option value="responsable">Admin</option></select>`;
document.getElementById('modal-save').onclick = () => this.saveUser(data ? 'PUT' : 'POST');
c.classList.remove('hidden');
},

async saveUser(method) {
const id = document.getElementById('m-user-id').value;
const payload = {
prenom: document.getElementById('m-user-prenom').value,
email: document.getElementById('m-user-email').value,
role: document.getElementById('m-user-role').value
};
App.showLoader(true);
try {
const res = await fetch(method === 'PUT' ? `/api/management/users/${id}` : '/api/management/users', {
method,
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${
App.token
}`
},
body: JSON.stringify(payload)
});
if (res.ok) {
this.closeModal();
App.loadUsers();
}
} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async editUser(id) {
App.showLoader(true);
try {
const res = await fetch('/api/management/users', {
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
const users = await res.json();
const u = users.find(u => u.id === parseInt(id));
if (u) 
this.showUserModal(u);



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async manageFields(cid) {
App.showLoader(true);
try {
const res = await fetch(`/api/management/campaigns/${cid}/fields`, {
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
const fields = await res.json();
document.getElementById('modal-title').innerText = "Champs";
document.getElementById('modal-body').innerHTML = `<div>${
fields.map(f => `<div>${
f.label
} <button onclick="UI.deleteField(${
f.id
}, ${cid})">üóëÔ∏è</button></div>`).join('')
}</div><input id="new-field-label"><button onclick="UI.addField(${cid})">Ajouter</button>`;
document.getElementById('modal-container').classList.remove('hidden');
} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async addField(cid) {
const label = document.getElementById('new-field-label').value;
App.showLoader(true);
try {
const res = await fetch(`/api/management/campaigns/${cid}/fields`, {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${
App.token
}`
},
body: JSON.stringify(
{label, type: 'text'}
)
});
if (res.ok) 
this.manageFields(cid);



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async deleteField(fid, cid) {
App.showLoader(true);
try {
const res = await fetch(`/api/management/fields/${fid}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
if (res.ok) 
this.manageFields(cid);



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async manageAssignments(cid) {
App.showLoader(true);
try {
const resA = await fetch(`/api/management/campaigns/${cid}/users`, {
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
const ass = await resA.json();
const resU = await fetch('/api/management/users', {
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
const users = await resU.json();
document.getElementById('modal-title').innerText = "Affectations";
document.getElementById('modal-body').innerHTML = `<div>${
ass.map(a => `<div>${
a.nom
} <button onclick="UI.unassignUser(${
a.id
}, ${cid})">üóëÔ∏è</button></div>`).join('')
}</div><select id="assign-user-select">${
users.map(u => `<option value="${
u.id
}">${
u.prenom
}</option>`).join('')
}</select><button onclick="UI.doAssign(${cid})">Affecter</button>`;
document.getElementById('modal-container').classList.remove('hidden');
} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async doAssign(cid) {
const uid = document.getElementById('assign-user-select').value;
App.showLoader(true);
try {
const res = await fetch(`/api/management/campaigns/${cid}/assign/${uid}`, {
method: 'POST',
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
if (res.ok) 
this.manageAssignments(cid);



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async unassignUser(aid, cid) {
App.showLoader(true);
try {
const res = await fetch(`/api/management/assignments/${aid}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
if (res.ok) 
this.manageAssignments(cid);



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async deleteUser(id) {
if (!confirm("Supprimer ?")) 
return;



App.showLoader(true);
try {
const res = await fetch(`/api/management/users/${id}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
if (res.ok) 
App.loadUsers();



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
}
};


document.addEventListener('DOMContentLoaded', () => {
console.log("App: DOM fully loaded, initializing...");
App.init();
});
</script>
