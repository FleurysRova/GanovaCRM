{% extends 'base.html.twig' %}

{% block title %}Zanova CRM | High Performance
{% endblock %}

{% block body %}
<div
	id="full-app" class="theme-dark">
	<!-- Overlay de Chargement -->
	<div id="global-loader" class="loader-overlay hidden">
		<div class="loader-content">
			<div class="spinner"></div>
			<p>Synchronisation Zanova...</p>
		</div>
	</div>

	<!-- √âcran de Login -->
	<div id="auth-screen" class="screen animate-fade-in">
		<div class="auth-card">
			<div class="auth-header">
				<div class="logo-circle">Z</div>
				<h1>Zanova<span class="accent">CRM</span>
				</h1>
				<p>Syst√®me de gestion haute performance</p>
			</div>

			<div id="login-form" class="auth-body">
				<div id="auth-error" class="hidden alert-box error"></div>
				<div id="auth-success" class="hidden alert-box success" style="position: static; margin-bottom: 1rem;"></div>

				<div class="input-group">
					<label>Email Professionnel</label>
					<input type="email" id="email" value="admin@zanova.com" placeholder="nom@zanova.com">
				</div>

				<div class="input-group">
					<label>Mot de passe</label>
					<input type="password" id="password" value="admin123" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
				</div>

				<button id="btn-login" class="btn-glow">
					<span>Acc√©der √† la plateforme</span>
				</button>
				<p style="text-align:center; margin-top:1.5rem; font-size:0.9rem; color:var(--text-dim);">
					Pas encore de compte ?
					<a href="#" onclick="event.preventDefault(); App.toggleAuthMode('register')" style="color:var(--primary); font-weight:700; text-decoration:none;">S'inscrire</a>
				</p>
			</div>

			<div id="register-form" class="auth-body hidden">
				<div id="reg-error" class="hidden alert-box error"></div>

				<div class="modal-grid">
					<div class="input-group">
						<label>Pr√©nom</label>
						<input type="text" id="reg-prenom" placeholder="Jean">
					</div>
					<div class="input-group">
						<label>Nom</label>
						<input type="text" id="reg-nom" placeholder="Dupont">
					</div>
				</div>

				<div class="input-group">
					<label>Email Professionnel</label>
					<input type="email" id="reg-email" placeholder="nom@zanova.com">
				</div>

				<div class="input-group">
					<label>Mot de passe</label>
					<input type="password" id="reg-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
				</div>

				<div class="input-group">
					<label>R√¥le souhait√©</label>
					<select id="reg-role" class="modal-select">
						<option value="agent">Agent (Appelant)</option>
						<option value="superviseur">Superviseur</option>
						<option value="responsable">Responsable (Admin)</option>
					</select>
				</div>

				<button id="btn-register" class="btn-glow" onclick="App.register()">
					<span>Demander l'acc√®s</span>
				</button>
				<p style="text-align:center; margin-top:1.5rem; font-size:0.9rem; color:var(--text-dim);">
					D√©j√† inscrit ?
					<a href="#" onclick="event.preventDefault(); App.toggleAuthMode('login')" style="color:var(--primary); font-weight:700; text-decoration:none;">Se connecter</a>
				</p>
			</div>
			<div class="auth-footer">
				<button onclick="App.toggleTheme()" class="btn-theme-minimal">üé® Changer de mode</button>
			</div>
		</div>
	</div>

	<!-- Dashboard Principal -->
	<div id="main-dashboard" class="screen hidden">
		<aside id="sidebar" class="sidebar">
			<div class="sidebar-header">
				<div class="logo-mini">Z</div>
				<h2 class="sidebar-label">Zanova</h2>
				<button id="sidebar-toggle" class="btn-collapse">‚óÄ</button>
			</div>

			<nav class="sidebar-nav">
				<a href="#" class="nav-item active" onclick="App.switchView('dashboard')">
					<span class="icon">üìä</span>
					<span class="sidebar-label">Tableau de bord</span>
				</a>
				<a href="#" class="nav-item" onclick="App.switchView('campaigns')">
					<span class="icon">üéØ</span>
					<span class="sidebar-label">Campagnes</span>
				</a>
				<a href="#" class="nav-item" onclick="App.switchView('contacts')">
					<span class="icon">üë•</span>
					<span class="sidebar-label">R√©pertoire Contacts</span>
				</a>
				<a href="#" class="nav-item" onclick="App.switchView('users')">
					<span class="icon">üõ°Ô∏è</span>
					<span class="sidebar-label">√âquipe & Acc√®s</span>
				</a>

				<div style="margin-top: 2rem; padding: 0 0.5rem;">
					<button onclick="UI.showContactModal()" class="btn-glow" style="width: 100%; justify-content: center; font-size: 0.9rem; padding: 0.8rem 1rem; border-radius: 14px;">
						<span class="icon" style="margin-right: 8px;">‚ûï</span>
						<span class="sidebar-label">Nouveau Contact</span>
					</button>
				</div>
			</nav>

			<div class="sidebar-footer">
				<div class="user-info sidebar-label">
					<p id="user-name">Chargement...</p>
					<span id="user-role" class="badge">Role</span>
				</div>
				<button id="btn-logout" class="btn-icon" title="D√©connexion">üîì</button>
			</div>
		</aside>

		<main class="content-area">
			<header class="top-header">
				<div class="header-left">
					<button id="mobile-menu-toggle" class="btn-mobile">‚ò∞</button>
					<h2 id="page-title">Tableau de Bord</h2>
				</div>
				<div class="top-actions">
					<button onclick="App.toggleTheme()" class="btn-icon-alt" title="Mode Sombre/Clair">üåì</button>
					<div class="status-box">
						<span class="status-indicator"></span>
						<span class="res-hide">Serveur Op√©rationnel</span>
					</div>
				</div>
			</header>

			<div
				id="view-container" class="view-content">
				<!-- Vue Overview -->
				<div id="overview-view" class="view">
					<div class="stats-grid">
						<div class="stat-card">
							<label>Campagnes Actives</label>
							<h3 id="stat-campaigns">0</h3>
						</div>
						<div class="stat-card">
							<label>Agents Connect√©s</label>
							<h3 id="stat-agents">0</h3>
						</div>
						<div class="stat-card">
							<label>Total Appels Jour</label>
							<h3 id="stat-calls">0</h3>
						</div>
					</div>

					<div class="dashboard-panels">
						<section class="panel">
							<h3>Activit√© R√©cente</h3>
							<div id="activity-log" class="log-list">
								<p class="empty text-dim">Aucune activit√© r√©cente.</p>
							</div>
						</section>
					</div>
				</div>

				<!-- Vue Campagnes -->
				<div id="campaigns-view" class="view hidden">
					<div class="view-header-flex">
						<div class="title-group">
							<h2 style="font-family: 'Outfit'; font-weight: 800; font-size: 2rem; margin: 0;">Gestion des Campagnes</h2>
							<p style="color: var(--text-dim); margin: 5px 0 0 0;">Pilotez et optimisez vos op√©rations d'appels</p>
						</div>
						<button onclick="UI.showCampaignModal()" class="btn-glow">
							<svg fill="currentColor" viewbox="0 0 20 20">
								<path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-20v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
							</svg>
							Lancer une campagne
						</button>
					</div>

					<div class="panel" style="margin-top: 2.5rem;">
						<div class="table-container">
							<table class="data-table">
								<thead>
									<tr>
										<th>Campagne</th>
										<th>P√©riode</th>
										<th>Responsable</th>
										<th>Contacts</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody id="campaign-list-body"></tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Vue Contacts -->
				<div id="contacts-view" class="view hidden">
					<div class="view-header-flex">
						<div class="title-group">
							<h2 style="font-family: 'Outfit'; font-weight: 800; font-size: 2rem; margin: 0;">R√©pertoire Global</h2>
							<p style="color: var(--text-dim); margin: 5px 0 0 0;">Visualisez l'ensemble de vos contacts prospect√©s</p>
						</div>
					</div>

					<div class="dashboard-panels" style="margin-top: 2rem;">
						<div class="panel">
							<div class="panel-header">
								<h3>Liste des Contacts</h3>
								<div id="contact-actions-area">
									<button id="btn-add-contact" class="btn-glow small hidden" onclick="UI.showContactModal()">
										+ Ajouter un contact
									</button>
								</div>
							</div>
							<div class="table-container">
								<table class="data-table">
									<thead>
										<tr>
											<th>Contact</th>
											<th>Coordonn√©es</th>
											<th>Source</th>
											<th>Statut</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody id="contact-list-body">
										<tr>
											<td colspan="5" style="text-align:center; padding:3rem; color:var(--text-dim);">Veuillez s√©lectionner une campagne √† droite.</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
						<div class="panel">
							<div class="panel-header">
								<h3>Campagnes</h3>
							</div>
							<div
								id="contact-campaign-selector" style="display:flex; flex-direction:column; gap:8px;"><!-- Rempli par JS -->
							</div>
						</div>
					</div>
				</div>

				<!-- Vue √âquipe -->
				<div id="users-view" class="view hidden">
					<div class="view-header-flex">
						<div class="title-group">
							<h2 style="font-family: 'Outfit'; font-weight: 800; font-size: 2rem; margin: 0;">Gestion d'√âquipe</h2>
							<p style="color: var(--text-dim); margin: 5px 0 0 0;">G√©rez vos agents et superviseurs</p>
						</div>
						<button onclick="UI.showUserModal()" class="btn-glow">
							<svg fill="currentColor" viewbox="0 0 20 20">
								<path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"></path>
							</svg>
							Ajouter un membre
						</button>
					</div>

					<div id="pending-users-section" class="restricted-responsable hidden" style="margin-bottom: 3rem;">
						<div class="panel-header">
							<h3 style="color:var(--primary);">‚è≥ Inscriptions en attente</h3>
							<p style="font-size: 0.85rem; color: var(--text-dim);">Ces utilisateurs doivent √™tre valid√©s pour acc√©der au CRM</p>
						</div>
						<div class="table-container">
							<table class="data-table">
								<thead>
									<tr>
										<th>Candidat</th>
										<th>Email</th>
										<th>Role Demand√©</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody id="pending-user-list-body"></tbody>
							</table>
						</div>
					</div>

					<div class="panel">
						<div class="panel-header">
							<h3>Membres Actifs</h3>
						</div>
						<div class="table-container">
							<table class="data-table">
								<thead>
									<tr>
										<th>Membre</th>
										<th>Email</th>
										<th>R√¥le</th>
										<th>Statut</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody id="user-list-body"></tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Modal Generic -->
		<div id="modal-container" class="modal-overlay hidden">
			<div class="modal-card">
				<div class="modal-header">
					<h3 id="modal-title">Formulaire</h3>
					<button onclick="UI.closeModal()" class="btn-close">√ó</button>
				</div>
				<div id="modal-body" class="modal-content"></div>
				<div class="modal-footer">
					<button id="modal-save" class="btn-glow">Enregistrer</button>
				</div>
			</div>
		</div>
	</main>
</div></div><style>
.view-header-flex {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 2rem;
}
.btn-glow.small {
	width: auto;
	padding: 0.6rem 1.2rem;
	font-size: 0.85rem;
}

/* TABLES */
.table-container {
	overflow-x: auto;
	margin-top: 1rem;
}
.data-table {
	width: 100%;
	border-collapse: collapse;
	text-align: left;
}
.data-table th {
	color: var(--text-dim);
	font-size: 0.8rem;
	text-transform: uppercase;
	padding: 1rem;
	border-bottom: 1px solid var(--border);
}
.data-table td {
	padding: 1rem;
	border-bottom: 1px solid var(--border);
	font-size: 0.9rem;
}
.data-table tr:hover {
	background: var(--glass);
}

.action-btns {
	display: flex;
	gap: 8px;
}
.btn-action {
	background: var(--glass);
	border: 1px solid var(--border);
	color: var(--text-main);
	padding: 4px 8px;
	border-radius: 6px;
	cursor: pointer;
	font-size: 0.8rem;
}
.btn-action.delete {
	color: var(--danger);
}
.btn-action.delete:hover {
	background: var(--danger);
	color: white;
}

/* MODAL PREMIUM REDESIGN */
.modal-overlay {
	position: fixed;
	inset: 0;
	background: rgba(8, 11, 20, 0.85);
	z-index: 2000;
	display: flex;
	align-items: center;
	justify-content: center;
	backdrop-filter: blur(12px);
	padding: 20px;
}
.modal-card {
	background: var(--bg-surface);
	width: 100%;
	max-width: 650px; /* Plus large */
	border-radius: 28px;
	border: 1px solid var(--border);
	box-shadow: 0 40px 80px -20px var(--shadow);
	overflow: hidden;
	animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes modalSlideUp {
	from {
		transform: translateY(30px);
		opacity: 0;
	}
	to {
		transform: translateY(0);
		opacity: 1;
	}
}
.modal-header {
	padding: 2rem;
	display: flex;
	justify-content: space-between;
	align-items: center;
	background: linear-gradient(to bottom, var(--glass), transparent);
	border-bottom: 1px solid var(--border);
}
.modal-header h3 {
	font-family: 'Outfit';
	font-size: 1.5rem;
	margin: 0;
}
.modal-content {
	padding: 2.5rem;
}
.btn-close {
	background: var(--glass);
	border: 1px solid var(--border);
	width: 36px;
	height: 36px;
	border-radius: 50%;
	font-size: 1.2rem;
	color: var(--text-dim);
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	transition: 0.2s;
}
.btn-close:hover {
	background: var(--danger);
	color: white;
	border-color: var(--danger);
}
.modal-footer {
	padding: 1.5rem 2.5rem;
	display: flex;
	justify-content: flex-end;
	gap: 1rem;
	background: var(--glass);
	border-top: 1px solid var(--border);
}

/* FORM STYLING IN MODAL */
.modal-content .input-group {
	margin-bottom: 2rem;
}
.modal-content label {
	display: block;
	font-weight: 700;
	color: var(--text-main);
	font-size: 0.85rem;
	margin-bottom: 0.8rem;
	text-transform: uppercase;
	letter-spacing: 0.5px;
}
.modal-content input,
.modal-content textarea {
	width: 100%;
	background: var(--bg-app);
	border: 1px solid var(--border);
	padding: 1.25rem 1.5rem;
	font-size: 1.05rem;
	border-radius: 16px;
	color: var(--text-main);
	transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	box-sizing: border-box;
}
.modal-content input:focus,
.modal-content textarea:focus {
	outline: none;
	border-color: var(--primary);
	background: var(--bg-surface);
	box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.15);
	transform: translateY(-2px);
}
.modal-content textarea {
	min-height: 140px;
	resize: none;
	line-height: 1.6;
}

.modal-select {
	width: 100%;
	background: var(--bg-app);
	border: 1px solid var(--border);
	padding: 1.25rem 1.5rem;
	font-size: 1.05rem;
	border-radius: 16px;
	color: var(--text-main);
	transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	box-sizing: border-box;
	appearance: none;
	background-image: url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
	background-repeat: no-repeat;
	background-position: right 1.5rem center;
	background-size: 1.5rem;
}
.modal-select:focus {
	outline: none;
	border-color: var(--primary);
	box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.15);
}

.animate-fade-in {
	animation: fadeIn 0.4s ease-out;
}
.modal-grid {
	display: grid;
	grid-template-columns: 1fr 1fr;
	gap: 2rem;
}
@media(max-width: 600px) {
	.modal-grid {
		grid-template-columns: 1fr;
		gap: 1rem;
	}
}

.btn-modal-save {
	background: var(--primary);
	color: white;
	border: none;
	padding: 1.25rem 2.5rem;
	border-radius: 16px;
	font-weight: 700;
	font-size: 1rem;
	cursor: pointer;
	transition: all 0.3s;
	box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2);
}
.btn-modal-save:hover {
	transform: translateY(-3px);
	box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
	background: var(--accent);
}</style><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet"><style>/* VARIABLES THEMES HYPER-PREMIUM */:root,
[data-theme="dark"] {
	--bg-app: #0a0f1d; /* Midnight Blue profond au lieu du noir */
	--bg-surface: #12192b;
	--bg-card: rgba(30, 41, 59, 0.5);
	--sidebar-bg: rgba(15, 23, 42, 0.9);
	--text-main: #f1f5f9;
	--text-dim: #94a3b8;
	--border: rgba(255, 255, 255, 0.08);
	--primary: #3b82f6;
	--primary-glow: rgba(59, 130, 246, 0.3);
	--accent: #6366f1;
	--danger: #ef4444;
	--success: #10b981;
	--glass: rgba(255, 255, 255, 0.03);
	--glass-border: rgba(255, 255, 255, 0.1);
	--shadow: rgba(2, 6, 23, 0.5);
	--grad-main: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
}

[data-theme="light"] {
	--bg-app: #f1f5f9;
	--bg-surface: #ffffff;
	--bg-card: rgba(255, 255, 255, 0.8);
	--sidebar-bg: #ffffff;
	--text-main: #0f172a;
	--text-dim: #64748b;
	--border: rgba(0, 0, 0, 0.05);
	--primary: #2563eb;
	--primary-glow: rgba(37, 99, 235, 0.2);
	--accent: #4f46e5;
	--danger: #dc2626;
	--success: #16a34a;
	--glass: rgba(0, 0, 0, 0.02);
	--glass-border: rgba(0, 0, 0, 0.05);
	--shadow: rgba(0, 0, 0, 0.05);
	--grad-main: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
}

html {
	transition: background 0.3s ease;
}

/* GLOBAL */
body {
	margin: 0;
	background: var(--bg-app);
	color: var(--text-main);
	font-family: 'Inter', sans-serif;
	transition: background 0.4s cubic-bezier(0.16, 1, 0.3, 1);
	height: 100vh;
	overflow: hidden;
	display: flex;
}

.screen {
	height: 100vh;
	width: 100vw;
	display: flex;
	position: relative;
}
.hidden {
	display: none !important;
}

/* SIDEBAR GLASSMORPHISM */
.sidebar {
	width: 280px;
	background: var(--sidebar-bg);
	backdrop-filter: blur(20px);
	-webkit-backdrop-filter: blur(20px);
	border-right: 1px solid var(--border);
	display: flex;
	flex-direction: column;
	padding: 2rem 1.5rem;
	transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
	position: relative;
	z-index: 100;
}
.sidebar.collapsed {
	width: 90px;
	padding: 2rem 1rem;
}
.sidebar.collapsed .sidebar-label {
	display: none;
}

.sidebar-header {
	display: flex;
	align-items: center;
	gap: 1rem;
	margin-bottom: 3.5rem;
	padding-left: 0.5rem;
}
.logo-mini {
	width: 44px;
	height: 44px;
	background: var(--grad-main);
	border-radius: 14px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-weight: 800;
	color: white;
	flex-shrink: 0;
	font-family: 'Outfit';
	box-shadow: 0 8px 16px var(--primary-glow);
}
.btn-collapse {
	background: var(--glass);
	border: 1px solid var(--border);
	color: var(--text-dim);
	border-radius: 8px;
	cursor: pointer;
	padding: 5px 9px;
	font-size: 0.75rem;
	transition: 0.2s;
}
.btn-collapse:hover {
	color: var(--text-main);
	border-color: var(--primary);
}

.sidebar-nav {
	flex: 1;
	display: flex;
	flex-direction: column;
	gap: 0.5rem;
}
.nav-item {
	display: flex;
	align-items: center;
	padding: 1rem 1.25rem;
	border-radius: 16px;
	color: var(--text-dim);
	text-decoration: none;
	transition: all 0.3s ease;
	font-family: 'Outfit';
	font-weight: 500;
	letter-spacing: 0.2px;
}
.nav-item:hover {
	background: var(--glass);
	color: var(--text-main);
	transform: translateX(5px);
}
.nav-item.active {
	background: var(--grad-main);
	color: white;
	box-shadow: 0 10px 20px -5px var(--primary-glow);
}
.nav-item .icon {
	font-size: 1.4rem;
	margin-right: 1.25rem;
	min-width: 28px;
	text-align: center;
}
.sidebar.collapsed .nav-item {
	justify-content: center;
	padding: 1.2rem;
}
.sidebar.collapsed .nav-item .icon {
	margin-right: 0;
}

.sidebar-footer {
	padding-top: 1.5rem;
	border-top: 1px solid var(--border);
	display: flex;
	align-items: center;
	gap: 1rem;
}
.user-avatar {
	width: 40px;
	height: 40px;
	border-radius: 12px;
	background: var(--glass);
	display: flex;
	align-items: center;
	justify-content: center;
	border: 1px solid var(--border);
}
.user-info p {
	font-size: 0.95rem;
	font-weight: 700;
	margin: 0;
	font-family: 'Outfit';
}

/* BADGES DISCRETS & CLASS */
.badge {
	font-size: 0.7rem;
	padding: 4px 12px;
	border-radius: 20px;
	font-weight: 700;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	display: inline-flex;
	align-items: center;
	border: 1px solid transparent;
	backdrop-filter: blur(4px);
}
.badge-primary {
	background: rgba(59, 130, 246, 0.1);
	color: #60a5fa;
	border-color: rgba(59, 130, 246, 0.2);
}
.badge-success {
	background: rgba(16, 185, 129, 0.1);
	color: #34d399;
	border-color: rgba(16, 185, 129, 0.2);
}
.badge-admin {
	background: rgba(99, 102, 241, 0.1);
	color: #818cf8;
	border-color: rgba(99, 102, 241, 0.2);
}
.badge-danger {
	background: rgba(239, 68, 68, 0.1);
	color: #f87171;
	border-color: rgba(239, 68, 68, 0.2);
}
.badge-neutral {
	background: var(--glass);
	color: var(--text-dim);
	border-color: var(--border);
}

/* CONTENT AREA LUXE */
.content-area {
	flex: 1;
	display: flex;
	flex-direction: column;
	overflow-y: auto;
	background: var(--bg-app);
	position: relative;
}
.content-area::before {
	content: '';
	position: absolute;
	top: -10%;
	right: -10%;
	width: 40%;
	height: 40%;
	background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%);
	opacity: 0.4;
	pointer-events: none;
	z-index: 0;
}

.top-header {
	padding: 1.5rem 3rem;
	background: rgba(var(--bg-surface-rgb), 0.8);
	backdrop-filter: blur(15px);
	border-bottom: 1px solid var(--border);
	display: flex;
	justify-content: space-between;
	align-items: center;
	position: sticky;
	top: 0;
	z-index: 50;
}
.header-left h2 {
	font-family: 'Outfit';
	font-weight: 800;
	font-size: 1.75rem;
	margin: 0;
	letter-spacing: -0.02em;
}
.top-actions {
	display: flex;
	gap: 1.5rem;
	align-items: center;
}
.status-box {
	font-size: 0.8rem;
	color: var(--text-dim);
	display: flex;
	align-items: center;
	gap: 8px;
}
.status-indicator {
	width: 8px;
	height: 8px;
	background: var(--success);
	border-radius: 50%;
	box-shadow: 0 0 8px var(--success);
}

.view-content {
	padding: 3rem;
	max-width: 1600px;
	margin: 0 auto;
	width: 100%;
	box-sizing: border-box;
	position: relative;
	z-index: 1;
}

/* GRIDS & CARDS LOURDS */
.stats-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
	gap: 2rem;
	margin-bottom: 3rem;
}
.stat-card {
	background: var(--bg-card);
	padding: 2rem;
	border-radius: 24px;
	border: 1px solid var(--glass-border);
	backdrop-filter: blur(10px);
	box-shadow: 0 20px 40px var(--shadow);
	transition: transform 0.3s ease, border-color 0.3s ease;
}
.stat-card:hover {
	transform: translateY(-8px);
	border-color: var(--primary);
}
.stat-card label {
	font-size: 0.85rem;
	color: var(--text-dim);
	text-transform: uppercase;
	letter-spacing: 1px;
	font-weight: 700;
}
.stat-card h3 {
	font-size: 2.5rem;
	margin: 10px 0 0;
	font-family: 'Outfit';
	font-weight: 800;
	background: var(--grad-main);
	-webkit-background-clip: text;
	-webkit-text-fill-color: transparent;
}

.dashboard-panels {
	display: grid;
	grid-template-columns: 1.8fr 1fr;
	gap: 2rem;
}
.panel {
	background: var(--bg-card);
	padding: 2rem;
	border-radius: 24px;
	border: 1px solid var(--glass-border);
	backdrop-filter: blur(10px);
	box-shadow: 0 15px 30px var(--shadow);
}
.panel-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 2rem;
	border-bottom: 1px solid var(--border);
	padding-bottom: 1rem;
}
.panel-header h3 {
	font-family: 'Outfit';
	font-size: 1.25rem;
	margin: 0;
	font-weight: 700;
}

/* TABLES LUXE */
.table-container {
	overflow-x: auto;
}
.data-table {
	width: 100%;
	border-collapse: separate;
	border-spacing: 0 10px;
	text-align: left;
}
.data-table th {
	color: var(--text-dim);
	font-size: 0.75rem;
	text-transform: uppercase;
	padding: 0.5rem 1.5rem;
	font-weight: 800;
	letter-spacing: 1px;
}
.data-table td {
	padding: 1.5rem;
	background: var(--glass);
	font-size: 0.95rem;
	transition: 0.2s;
	border-bottom: 1px solid transparent;
}
.data-table tr td:first-child {
	border-radius: 16px 0 0 16px;
	font-weight: 600;
}
.data-table tr td:last-child {
	border-radius: 0 16px 16px 0;
}
.data-table tr:hover td {
	background: rgba(59, 130, 246, 0.1);
	border-color: var(--border);
	cursor: default;
}

/* BUTTONS EVOLVED */
.btn-glow {
	background: var(--grad-main);
	color: white;
	font-weight: 700;
	padding: 1rem 1.75rem;
	border-radius: 16px;
	border: none;
	cursor: pointer;
	transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
	display: inline-flex;
	align-items: center;
	gap: 0.75rem;
	font-family: 'Outfit';
	box-shadow: 0 10px 20px -5px var(--primary-glow);
}
.btn-glow:hover {
	transform: translateY(-3px);
	box-shadow: 0 15px 30px -10px var(--primary-glow);
}
.btn-glow svg {
	width: 20px;
	height: 20px;
}

.btn-icon-alt {
	background: var(--glass);
	border: 1px solid var(--border);
	color: var(--text-main);
	padding: 12px;
	border-radius: 14px;
	cursor: pointer;
	transition: 0.3s;
}
.btn-icon-alt:hover {
	background: var(--border);
	transform: scale(1.1);
}

/* ACTIVITIES & ALERTS */
.activity-item {
	padding: 1.25rem;
	border-radius: 16px;
	background: var(--glass);
	margin-bottom: 0.75rem;
	display: flex;
	gap: 1.25rem;
	align-items: center;
	border: 1px solid transparent;
	transition: 0.3s;
}
.activity-item:hover {
	border-color: var(--border);
	background: var(--bg-app);
}
/* RESPONSIVE AGRESSIF */
@media(max-width: 1200px) {
	.dashboard-panels {
		grid-template-columns: 1fr;
	}
}
@media(max-width: 768px) {
	.sidebar {
		position: fixed;
		left: -280px;
		top: 0;
		bottom: 0;
		width: 280px;
		box-shadow: 20px 0 40px rgba(0, 0, 0, 0.5);
	}
	.sidebar.mobile-open {
		left: 0;
	}
	.btn-mobile {
		display: block;
		background: var(--glass);
		border: 1px solid var(--border);
		padding: 8px;
		border-radius: 10px;
		color: var(--text-main);
		font-size: 1.2rem;
		cursor: pointer;
	}
	.res-hide {
		display: none;
	}
	.view-content {
		padding: 1.5rem;
	}
	.top-header {
		padding: 1rem 1.5rem;
	}
}

/* LOADER LUXE */
.loader-overlay {
	position: fixed;
	inset: 0;
	background: rgba(0, 0, 0, 0.8);
	z-index: 10000;
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center; backdrop-filter: blur(12px);
}
.spinner {
	width: 50px;
	height: 50px;
	border: 4px solid var(--glass);
	border-top-color: var(--primary);
	border-radius: 50%;
	animation: spin 0.8s cubic-bezier(0.5, 0.1, 0.5, 0.9) infinite;
	margin-bottom: 1.5rem; filter: drop-shadow(0 0 10px var(--primary-glow));
}
@keyframes spin {
	to {
		transform: rotate(360deg);
	}
}
.loader-overlay p {
	font-family: 'Outfit';
	font-weight: 700;
	color: white;
	letter-spacing: 1px;
	animation: pulse 1.5s infinite;
}
@keyframes pulse {
	0,
	100% {
		opacity: 1;
	}
	50% {
		opacity: 0.5;
	}
}

/* ALERTS PRECIS */
.alert-box {
	padding: 1.25rem 2.5rem;
	border-radius: 20px;
	font-weight: 800;
	font-family: 'Outfit';
	position: fixed;
	top: 2rem;
	right: 2rem;
	z-index: 10000;
	box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
	animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1);
	display: flex;
	align-items: center;
	gap: 1rem;
}
.alert-box.success {
	background: var(--grad-main);
	color: white;
	border: 1px solid rgba(255, 255, 255, 0.1);
}
@keyframes slideInRight {
	from {
		transform: translateX(100%);
		opacity: 0;
	}
	to {
		transform: translateX(0);
		opacity: 1;
	}
}
@keyframes fadeIn {
	from {
		opacity: 0;
		transform: translateY(10px);
	}
	to {
		opacity: 1;
		transform: translateY(0);
	}
}</style><script>window.App = {
							        token: localStorage.getItem('zanova_token'),
							        theme: localStorage.getItem('zanova_theme') || 'dark',
							        isSidebarCollapsed: localStorage.getItem('sidebar_collapsed') === 'true',
							        userData: null,
							        currentCampaignId: null,
							
							        init() {
							            this.applyTheme();
							            this.applySidebarState();
							            this.bindEvents();
							            if (this.token) this.bootApp();
							        },
							
							        bindEvents() {
							            document.getElementById('btn-login').addEventListener('click', () => this.login());
							            document.getElementById('btn-logout').addEventListener('click', () => this.logout());
							            document.getElementById('sidebar-toggle').addEventListener('click', () => this.toggleSidebar());
							            document.getElementById('mobile-menu-toggle').addEventListener('click', () => this.toggleMobileSidebar());
							
							            // Navigation
							            document.querySelectorAll('.nav-item').forEach(item => {
							                item.addEventListener('click', (e) => {
							                    e.preventDefault();
							                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
							                    item.classList.add('active');
							                    this.switchView(item.dataset.target);
							                    // Fermer le menu mobile apr√®s clic
							                    document.getElementById('sidebar').classList.remove('mobile-open');
							                });
							            });
							        },
							
							        toggleTheme() {
							            this.theme = this.theme === 'dark' ? 'light' : 'dark';
							            localStorage.setItem('zanova_theme', this.theme);
							            this.applyTheme();
							        },
							
							        toggleAuthMode(mode) {
							            if (mode === 'register') {
							                document.getElementById('login-form').classList.add('hidden');
							                document.getElementById('register-form').classList.remove('hidden');
							            } else {
							                document.getElementById('register-form').classList.add('hidden');
							                document.getElementById('login-form').classList.remove('hidden');
							            }
							        },
							
							        applyTheme() {
							            document.documentElement.setAttribute('data-theme', this.theme);
							        },
							
							        toggleSidebar() {
							            this.isSidebarCollapsed = !this.isSidebarCollapsed;
							            localStorage.setItem('sidebar_collapsed', this.isSidebarCollapsed);
							            this.applySidebarState();
							        },
							
							        applySidebarState() {
							            const sb = document.getElementById('sidebar');
							            if (this.isSidebarCollapsed) sb.classList.add('collapsed');
							            else sb.classList.remove('collapsed');
							        },
							
							        toggleMobileSidebar() {
							            document.getElementById('sidebar').classList.toggle('mobile-open');
							        },
							
							        async login() {
							            const email = document.getElementById('email').value;
							            const password = document.getElementById('password').value;
							            this.showLoader(true);
							            try {
							                const response = await fetch('/api/login_check', {
							                    method: 'POST',
							                    headers: { 'Content-Type': 'application/json' },
							                    body: JSON.stringify({ email, password })
							                });
							                const data = await response.json();
							                if (response.ok) {
							                    this.token = data.token;
							                    localStorage.setItem('zanova_token', this.token);
							                    await this.bootApp();
							                } else throw new Error(data.message || "Identifiants invalides");
							            } catch (err) {
							                const errBox = document.getElementById('auth-error');
							                errBox.innerText = err.message;
							                errBox.classList.remove('hidden');
							            } finally {
							                this.showLoader(false);
							            }
							        },
							
							        async register() {
							            const payload = {
							                prenom: document.getElementById('reg-prenom').value,
							                nom: document.getElementById('reg-nom').value,
							                email: document.getElementById('reg-email').value,
							                password: document.getElementById('reg-password').value,
				                            role: document.getElementById('reg-role').value
							            };
							
							            if (!payload.email || !payload.password || !payload.nom || !payload.prenom) {
							                alert("Veuillez remplir tous les champs");
							                return;
							            }
							
							            this.showLoader(true);
							            try {
							                const res = await fetch('/api/register', {
							                    method: 'POST',
							                    headers: { 'Content-Type': 'application/json' },
							                    body: JSON.stringify(payload)
							                });
							                const data = await res.json();
							                if (res.ok) {
							                    document.getElementById('auth-success').innerText = data.message;
							                    document.getElementById('auth-success').classList.remove('hidden');
							                    this.toggleAuthMode('login');
							                } else {
							                    throw new Error(data.error);
							                }
							            } catch (err) {
							                const errBox = document.getElementById('reg-error');
							                errBox.innerText = err.message;
							                errBox.classList.remove('hidden');
							            } finally { this.showLoader(false); }
							        },
							
							        async bootApp() {
							            this.showLoader(true);
							            try {
							                const response = await fetch('/api/profile', {
							                    headers: { 'Authorization': `Bearer ${this.token}` }
							                });
							                if (!response.ok) throw new Error("Expulsion");
							                const result = await response.json();
							                this.userData = result.data;
							                this.renderUI();
							                document.getElementById('auth-screen').classList.add('hidden');
							                document.getElementById('main-dashboard').classList.remove('hidden');
							            } catch (err) { this.logout(); } finally { this.showLoader(false); }
							        },
							
							        renderUI() {
							            document.getElementById('user-name').innerText = `${this.userData.prenom} ${this.userData.nom}`;
							            document.getElementById('user-role').innerText = this.userData.role_crm;
							            if (this.userData.roles.includes('ROLE_RESPONSABLE')) {
							                document.querySelectorAll('.restricted-responsable').forEach(el => el.classList.remove('hidden'));
							            }
							        },
							
							        switchView(target) {
							            document.getElementById('page-title').innerText = target.charAt(0).toUpperCase() + target.slice(1);
							            
							            // Masquer toutes les vues
							            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
							            const activeView = document.getElementById(target + '-view');
							            if (activeView) activeView.classList.remove('hidden');
							
							            if (target === 'campaigns') this.loadCampaigns();
							            if (target === 'users') this.loadUsers();
							            if (target === 'contacts') this.loadGlobalContacts();
							        },
							
							        async loadGlobalContacts() {
							            this.showLoader(true);
							            try {
							                const res = await fetch('/api/management/campaigns', {
							                    headers: { 'Authorization': `Bearer ${this.token}` }
							                });
							                const campaigns = await res.json();
							                const container = document.getElementById('contact-campaign-selector');
							                container.innerHTML = campaigns.map(c => `
							                    <div onclick="App.loadCampaignContacts(${c.id})" class="activity-item" style="cursor:pointer; transition:0.2s;" id="campaign-item-${c.id}">
							                        <strong>${c.nom}</strong>
							                    </div>
							                `).join('');
							                document.getElementById('btn-add-contact').classList.add('hidden');
							                document.getElementById('contact-list-body').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:3rem; color:var(--text-dim);">Veuillez s√©lectionner une campagne √† droite.</td></tr>';
							            } catch (err) { console.error(err); }
							            finally { this.showLoader(false); }
							        },
							
							        async loadCampaignContacts(campaignId) {
							            this.currentCampaignId = campaignId;
							            this.showLoader(true);
							            
							            // Highlight active campaign
							            document.querySelectorAll('#contact-campaign-selector .activity-item').forEach(el => el.style.borderColor = 'transparent');
							            const activeItem = document.getElementById(`campaign-item-${campaignId}`);
							            if(activeItem) activeItem.style.borderColor = 'var(--primary)';
							
							            try {
							                const res = await fetch(`/api/management/campaigns/${campaignId}/contacts`, {
							                    headers: { 'Authorization': `Bearer ${this.token}` }
							                });
							                const contacts = await res.json();
							                const tbody = document.getElementById('contact-list-body');
							                
							                document.getElementById('btn-add-contact').classList.remove('hidden');
							
							                tbody.innerHTML = contacts.length ? contacts.map(c => `
							                    <tr>
							                        <td><strong>${c.nom}</strong><br><small style="color:var(--text-dim)">ID: ${c.id}</small></td>
							                        <td>${c.telephone}<br><small>${c.email || '-'}</small></td>
							                        <td><span class="badge badge-neutral">${c.source}</span></td>
							                        <td><span class="badge ${c.status === 'nouveau' ? 'badge-primary' : (c.status === 'termine' ? 'badge-success' : 'badge-neutral')}">${c.status}</span></td>
							                        <td>
							                            <div class="action-btns">
							                                <button onclick="UI.editContact(${c.id})" class="btn-action">‚úèÔ∏è</button>
							                                <button onclick="UI.deleteContact(${c.id})" class="btn-action delete">üóëÔ∏è</button>
							                            </div>
							                        </td>
							                    </tr>
							                `).join('') : '<tr><td colspan="5" style="text-align:center; padding:2rem;">Aucun contact dans cette campagne.</td></tr>';
							            } catch (err) { alert(err.message); }
							            finally { this.showLoader(false); }
							        },
							
							        async loadCampaigns() {
							            console.log("--- D√©but rechargement campagnes ---");
							            this.showLoader(true);
							            try {
							                const res = await fetch('/api/management/campaigns?t=' + Date.now(), {
							                    method: 'GET',
							                    cache: 'no-store', // D√©sactive le cache navigateur
							                    headers: { 
							                        'Authorization': `Bearer ${this.token}`,
							                        'Accept': 'application/json'
							                    }
							                });
							                const data = await res.json();
							                console.log("Donn√©es re√ßues apr√®s reload:", data);
							                
							                if (!Array.isArray(data)) {
							                    console.error("Data received is not an array:", data);
							                    throw new Error(data.message || "R√©ponse invalide du serveur");
							                }
							
							                const tbody = document.getElementById('campaign-list-body');
							                tbody.innerHTML = data.length ? data.map(c => `
							                    <tr>
							                        <td><strong>${c.nom}</strong><br><small style="color:var(--text-dim)">ID: ${c.id}</small></td>
							                        <td>${c.date_debut || '-'} / ${c.date_fin || '-'}</td>
							                        <td>${c.responsable || 'Non assign√©'}</td>
							                        <td><span class='badge'>${c.contacts_count}</span></td>
							                        <td>
							                            <div class="action-btns">
							                                <button onclick="UI.manageAssignments(${c.id})" class="btn-action" title="Affectations">ü§ù</button>
							                                <button onclick="UI.manageFields(${c.id})" class="btn-action" title="Formulaire">üìã</button>
							                                <button onclick="UI.editCampaign(${c.id})" class="btn-action">‚úèÔ∏è</button>
							                                <button onclick="UI.deleteCampaign(${c.id})" class="btn-action delete">üóëÔ∏è</button>
							                            </div>
							                        </td>
							                    </tr>
							                `).join('') : '<tr><td colspan="5" style="text-align:center; padding: 2rem;">Aucune campagne trouv√©e</td></tr>';
							            } catch (err) { 
							                console.error("LoadCampaigns Error:", err);
							                alert("Erreur: " + err.message);
							            }
							            finally { this.showLoader(false); }
							        },
							
							        async loadUsers() {
							            this.showLoader(true);
							            try {
							                const res = await fetch('/api/management/users?t=' + Date.now(), {
							                    method: 'GET',
							                    cache: 'no-store',
							                    headers: { 
							                        'Authorization': `Bearer ${this.token}`,
							                        'Accept': 'application/json'
							                    }
							                });
							                const data = await res.json();
							                
							                if (!Array.isArray(data)) {
							                    throw new Error(data.message || "R√©ponse invalide du serveur");
							                }
							
							                const tbodyActive = document.getElementById('user-list-body');
							                const tbodyPending = document.getElementById('pending-user-list-body');
							                
							                const activeUsers = data.filter(u => u.status === 'active');
							                const pendingUsers = data.filter(u => u.status === 'inactive');
							
							                tbodyActive.innerHTML = activeUsers.map(u => {
							                    const roleClass = u.role === 'responsable' ? 'badge-admin' : (u.role === 'superviseur' ? 'badge-primary' : 'badge-neutral');
							                    return `
							                        <tr>
							                            <td><div style="display:flex; align-items:center; gap:12px;">
							                                <div class="user-avatar" style="width:32px; height:32px; font-size:0.8rem;">${u.prenom[0]}</div>
							                                <strong>${u.prenom} ${u.nom}</strong>
							                            </div></td>
							                            <td><span style="color:var(--text-dim); font-size:0.9rem;">${u.email}</span></td>
							                            <td><span class="badge ${roleClass}">${u.role}</span></td>
							                            <td><span class="badge badge-success">Actif</span></td>
							                            <td>
							                                <div class="action-btns">
							                                    <button onclick="UI.editUser(${u.id})" class="btn-action">‚úèÔ∏è</button>
							                                    <button onclick="UI.deleteUser(${u.id})" class="btn-action delete">üóëÔ∏è</button>
							                                </div>
							                            </td>
							                        </tr>
							                    `;
							                }).join('');
							
							                if (tbodyPending) {
							                    tbodyPending.innerHTML = pendingUsers.length ? pendingUsers.map(u => `
							                        <tr>
							                            <td><strong>${u.prenom} ${u.nom}</strong></td>
							                            <td><span style="color:var(--text-dim); font-size:0.9rem;">${u.email}</span></td>
							                            <td><span class="badge badge-neutral">${u.role}</span></td>
							                            <td>
							                                <button onclick="UI.validateUser(${u.id})" class="btn-glow small" style="background:var(--success); border-radius:8px; padding:0.5rem 1rem;">
							                                    ‚úÖ Valider l'acc√®s
							                                </button>
							                            </td>
							                        </tr>
							                    `) : '<tr><td colspan="4" style="text-align:center; padding:1rem; opacity:0.5;">Aucune inscription en attente</td></tr>';
							                }
							
							            } catch (err) { 
							                console.error("LoadUsers Error:", err);
							                alert("Erreur: " + err.message);
							            }
							            finally { this.showLoader(false); }
							        },
							
							        showLoader(show) { document.getElementById('global-loader').classList.toggle('hidden', !show); },
							
							        addActivity(msg) {
							            const container = document.getElementById('activity-log');
							            if (!container) return;
							            
							            const empty = container.querySelector('.empty');
							            if (empty) empty.remove();
							
							            const item = document.createElement('div');
							            item.className = 'activity-item';
							            const now = new Date();
							            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
							            
							            item.innerHTML = `<span class="time">${timeStr}</span> <p class="msg">${msg}</p>`;
							            container.prepend(item);
							        },
							
							        logout() {
							            localStorage.removeItem('zanova_token');
							            location.reload();
							        }
							    };
							
							    window.UI = {
							        async deleteCampaign(id) {
							            if(!confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer cette campagne ? Cette action est irr√©versible.")) return;
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/campaigns/${id}`, {
							                    method: 'DELETE',
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                if(res.ok) {
							                    App.addActivity("Campagne supprim√©e");
							                    App.loadCampaigns();
							                } else {
							                    throw new Error("Erreur lors de la suppression");
							                }
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async editCampaign(id) {
							            App.showLoader(true);
							            try {
							                const res = await fetch('/api/management/campaigns?t=' + Date.now(), {
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                const campaigns = await res.json();
							                const camp = campaigns.find(c => c.id === parseInt(id));
							
							                if (!camp) throw new Error("Campagne introuvable.");
							                this.showCampaignModal(camp);
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        showCampaignModal(existingData = null) {
							            const container = document.getElementById('modal-container');
							            const title = document.getElementById('modal-title');
							            const body = document.getElementById('modal-body');
							            const saveBtn = document.getElementById('modal-save');
							
							            title.innerText = existingData ? "Modifier la Campagne" : "Cr√©er une nouvelle Campagne";
							            body.innerHTML = `
							                <div class="animate-fade-in">
							                    <input type="hidden" id="m-camp-id" value="${existingData ? existingData.id : ''}">
							                    
							                    <div class="input-group">
							                        <label>Titre de la campagne</label>
							                        <input type="text" id="m-camp-nom" value="${existingData ? existingData.nom : ''}" placeholder="Ex: Campagne Acquisition Mars 2024">
							                    </div>
							
							                    <div class="input-group">
							                        <label>Objectifs & Description</label>
							                        <textarea id="m-camp-desc" placeholder="D√©crivez ici les sp√©cificit√©s de cette campagne...">${existingData ? (existingData.description || '') : ''}</textarea>
							                    </div>
							
							                    <div class="modal-grid">
							                        <div class="input-group">
							                            <label>Date de Lancement</label>
							                            <input type="date" id="m-camp-start" value="${existingData ? (existingData.date_debut || '') : ''}">
							                        </div>
							                        <div class="input-group">
							                            <label>√âch√©ance (Fin)</label>
							                            <input type="date" id="m-camp-end" value="${existingData ? (existingData.date_fin || '') : ''}">
							                        </div>
							                    </div>
							                </div>
							            `;
							            
							            saveBtn.className = "btn-modal-save";
							            saveBtn.innerText = existingData ? "Confirmer les modifications" : "Lancer la campagne";
							            saveBtn.onclick = () => this.saveCampaign(existingData ? 'PUT' : 'POST');
							            container.classList.remove('hidden');
							        },
							
							        async saveCampaign(method) {
							            const id = document.getElementById('m-camp-id').value;
							            const payload = {
							                nom: document.getElementById('m-camp-nom').value,
							                description: document.getElementById('m-camp-desc').value,
							                date_debut: document.getElementById('m-camp-start').value,
							                date_fin: document.getElementById('m-camp-end').value
							            };
							
							            if (!payload.nom) {
							                alert("‚ö†Ô∏è Le titre de la campagne est obligatoire.");
							                return;
							            }
							
							            const url = method === 'PUT' ? `/api/management/campaigns/${id}` : '/api/management/campaigns';
							
							            App.showLoader(true);
							            try {
							                const res = await fetch(url + '?t=' + Date.now(), {
							                    method: method,
							                    headers: { 
							                        'Content-Type': 'application/json', 
							                        'Authorization': `Bearer ${App.token}`,
							                        'Accept': 'application/json'
							                    },
							                    body: JSON.stringify(payload)
							                });
							                
							                const responseData = await res.json();
							
							                if (res.ok) {
							                    this.closeModal();
							                    App.addActivity(method === 'PUT' ? `Succ√®s: Campagne "${payload.nom}" mise √† jour` : `Succ√®s: Campagne "${payload.nom}" cr√©√©e`);
							                    
							                    // On attend un tout petit peu pour laisser le temps au flush DB de se propager
							                    setTimeout(async () => {
							                        await App.loadCampaigns();
							                        console.log("Liste rafra√Æchie avec succ√®s");
							                    }, 300);
							
							                    // Message de succ√®s temporaire
							                    const successMsg = document.createElement('div');
							                    successMsg.className = "alert-box success";
							                    successMsg.style.position = "fixed"; successMsg.style.top = "20px"; successMsg.style.right = "20px";
							                    successMsg.innerText = "Donn√©es enregistr√©es avec succ√®s !";
							                    document.body.appendChild(successMsg);
							                    setTimeout(() => successMsg.remove(), 3000);
							                } else {
							                    throw new Error(responseData.error || `Erreur serveur (Code: ${res.status})`);
							                }
							            } catch (err) { 
							                console.error("Save Error:", err);
							                alert("D√©tails de l'erreur: " + err.message); 
							            }
							            finally { App.showLoader(false); }
							        },
							
							        closeModal() {
							            document.getElementById('modal-container').classList.add('hidden');
							        },
							
							        // --- GESTION √âQUIPE (USERS) ---
							        showUserModal(existingData = null) {
							            const container = document.getElementById('modal-container');
							            const title = document.getElementById('modal-title');
							            const body = document.getElementById('modal-body');
							            const saveBtn = document.getElementById('modal-save');
							
							            title.innerText = existingData ? "Modifier le Membre" : "Ajouter un Membre";
							            body.innerHTML = `
							                <div class="animate-fade-in">
							                    <input type="hidden" id="m-user-id" value="${existingData ? existingData.id : ''}">
							                    <div class="modal-grid">
							                        <div class="input-group">
							                            <label>Pr√©nom</label>
							                            <input type="text" id="m-user-prenom" value="${existingData ? existingData.prenom : ''}" placeholder="Jean">
							                        </div>
							                        <div class="input-group">
							                            <label>Nom</label>
							                            <input type="text" id="m-user-nom" value="${existingData ? existingData.nom : ''}" placeholder="Dupont">
							                        </div>
							                    </div>
							                    <div class="input-group">
							                        <label>Email professionnel</label>
							                        <input type="email" id="m-user-email" value="${existingData ? existingData.email : ''}" placeholder="jean.dupont@zanova.com">
							                    </div>
							                    <div class="modal-grid">
							                        <div class="input-group">
							                            <label>R√¥le Syst√®me</label>
							                            <select id="m-user-role" class="modal-select">
							                                <option value="agent" ${existingData && existingData.role === 'agent' ? 'selected' : ''}>Agent (Appelant)</option>
							                                <option value="superviseur" ${existingData && existingData.role === 'superviseur' ? 'selected' : ''}>Superviseur</option>
							                                <option value="responsable" ${existingData && existingData.role === 'responsable' ? 'selected' : ''}>Responsable (Admin)</option>
							                            </select>
							                        </div>
							                        <div class="input-group">
							                            <label>Statut</label>
							                            <select id="m-user-status" class="modal-select">
							                                <option value="active" ${existingData && existingData.status === 'active' ? 'selected' : ''}>Actif</option>
							                                <option value="inactive" ${existingData && existingData.status === 'inactive' ? 'selected' : ''}>Inactif</option>
							                            </select>
							                        </div>
							                    </div>
							                </div>
							            `;
							            
							            saveBtn.className = "btn-modal-save";
							            saveBtn.innerText = existingData ? "Enregistrer les modifications" : "Cr√©er le profil";
							            saveBtn.onclick = () => this.saveUser(existingData ? 'PUT' : 'POST');
							            container.classList.remove('hidden');
							        },
							
							        async saveUser(method) {
							            const id = document.getElementById('m-user-id').value;
							            const payload = {
							                prenom: document.getElementById('m-user-prenom').value,
							                nom: document.getElementById('m-user-nom').value,
							                email: document.getElementById('m-user-email').value,
							                role: document.getElementById('m-user-role').value,
							                status: document.getElementById('m-user-status').value
							            };
							
							            const url = method === 'PUT' ? `/api/management/users/${id}` : '/api/management/users';
							            App.showLoader(true);
							            try {
							                const res = await fetch(url + '?t=' + Date.now(), {
							                    method: method,
							                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.token}` },
							                    body: JSON.stringify(payload)
							                });
							                if (res.ok) {
							                    this.closeModal();
							                    App.addActivity(`Membre ${payload.prenom} mis √† jour`);
							                    await App.loadUsers();
							                } else {
							                    const data = await res.json();
							                    throw new Error(data.error || "Erreur lors de la sauvegarde utilisateur");
							                }
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async editUser(id) {
							            App.showLoader(true);
							            try {
							                const res = await fetch('/api/management/users?t=' + Date.now(), {
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                const users = await res.json();
							                const user = users.find(u => u.id === parseInt(id));
							                if (user) this.showUserModal(user);
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async manageFields(campaignId) {
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/campaigns/${campaignId}/fields?t=` + Date.now(), {
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                const fields = await res.json();
							                
							                const container = document.getElementById('modal-container');
							                const title = document.getElementById('modal-title');
							                const body = document.getElementById('modal-body');
							                const saveBtn = document.getElementById('modal-save');
							
							                title.innerText = "Champs du Formulaire";
							                body.innerHTML = `
							                    <div class="animate-fade-in" style="min-width: 500px">
							                        <p style="color:var(--text-dim); margin-bottom:1.5rem;">D√©finissez les questions que l'agent devra remplir lors de l'appel.</p>
							                        <div id="fields-list" style="margin-bottom:2rem; display:flex; flex-direction:column; gap:10px;">
							                            ${fields.map(f => `
							                                <div class="activity-item" style="justify-content:space-between; padding:0.75rem 1rem;">
							                                    <div>
							                                        <strong>${f.label}</strong> 
							                                        <span class="badge badge-neutral" style="margin-left:10px">${f.type}</span>
							                                    </div>
							                                    <button onclick="UI.deleteField(${f.id}, ${campaignId})" class="btn-action delete" style="padding:4px">üóëÔ∏è</button>
							                                </div>
							                            `).join('') || '<p style="text-align:center; padding:1rem; opacity:0.5;">Aucun champ configur√©</p>'}
							                        </div>
							                        
							                        <div class="panel" style="background:var(--bg-app); padding:1rem;">
							                            <h4 style="margin:0 0 1rem 0; font-family:'Outfit'; font-size:0.9rem;">AJOUTER UN CHAMP</h4>
							                            <div class="modal-grid" style="gap:1rem;">
							                                <div class="input-group">
							                                    <label>Nom du champ</label>
							                                    <input type="text" id="new-field-label" placeholder="ex: Budget Client">
							                                </div>
							                                <div class="input-group">
							                                    <label>Type</label>
							                                    <select id="new-field-type" class="modal-select" style="padding:0.75rem 1rem;">
							                                        <option value="text">Texte</option>
							                                        <option value="number">Nombre</option>
							                                        <option value="date">Date</option>
							                                        <option value="textarea">Commentaire Long</option>
							                                    </select>
							                                </div>
							                            </div>
							                            <button onclick="UI.addField(${campaignId})" class="btn-glow" style="width:100%; margin-top:1rem; justify-content:center;">
							                                + Ajouter √† la campagne
							                            </button>
							                        </div>
							                    </div>
							                `;
							                
							                saveBtn.innerText = "Fermer";
							                saveBtn.onclick = () => this.closeModal();
							                container.classList.remove('hidden');
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async addField(campaignId) {
							            const label = document.getElementById('new-field-label').value;
							            const type = document.getElementById('new-field-type').value;
							            if(!label) return alert("Le nom est requis");
							
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/campaigns/${campaignId}/fields`, {
							                    method: 'POST',
							                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.token}` },
							                    body: JSON.stringify({ label, type, required: false })
							                });
							                if(res.ok) {
							                    App.addActivity("Nouveau champ ajout√©");
							                    this.manageFields(campaignId);
							                }
							            } catch (err) { alert("Erreur: " + err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async deleteField(fieldId, campaignId) {
							            if(!confirm("Supprimer ce champ ?")) return;
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/fields/${fieldId}`, {
							                    method: 'DELETE',
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                if(res.ok) {
							                    App.addActivity("Champ supprim√©");
							                    this.manageFields(campaignId);
							                }
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async manageAssignments(campaignId) {
							            App.showLoader(true);
							            try {
							                const resAss = await fetch(`/api/management/campaigns/${campaignId}/users?t=` + Date.now(), {
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                const assignments = await resAss.json();
							
							                const resAll = await fetch('/api/management/users?t=' + Date.now(), {
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                const allUsers = await resAll.json();
							
							                const container = document.getElementById('modal-container');
							                const title = document.getElementById('modal-title');
							                const body = document.getElementById('modal-body');
							                const saveBtn = document.getElementById('modal-save');
							
							                title.innerText = "Affectations de l'√âquipe";
							                body.innerHTML = `
							                    <div class="animate-fade-in" style="min-width: 500px">
							                        <div id="assignment-list" style="margin-bottom:2rem; display:flex; flex-direction:column; gap:10px;">
							                            <label style="font-size:0.75rem; font-weight:800; color:var(--text-dim); text-transform:uppercase;">MEMBRES ACTIFS</label>
							                            ${assignments.map(a => `
							                                <div class="activity-item" style="justify-content:space-between; padding:0.75rem 1rem;">
							                                    <div>
							                                        <strong>${a.nom}</strong> 
							                                        <span class="badge ${a.role === 'responsable' ? 'badge-admin' : 'badge-primary'}" style="margin-left:10px">${a.role}</span>
							                                    </div>
							                                    <button onclick="UI.unassignUser(${a.id}, ${campaignId})" class="btn-action delete" style="padding:4px">üóëÔ∏è</button>
							                                </div>
							                            `).join('') || '<p style="text-align:center; padding:1.5rem; background:var(--glass); border-radius:12px; opacity:0.5;">Aucun personnel affect√©</p>'}
							                        </div>
							
							                        <div class="panel" style="background:var(--bg-app); padding:1.5rem; border:1px solid var(--primary-glow);">
							                            <label style="font-size:0.75rem; font-weight:800; color:var(--primary); text-transform:uppercase; display:block; margin-bottom:1rem;">NOUVELLE AFFECTATION</label>
							                            <div style="display:flex; gap:1rem;">
							                                <select id="assign-user-select" class="modal-select" style="flex:1;">
							                                    <option value="">S√©lectionner un membre...</option>
							                                    ${allUsers.filter(u => !assignments.find(a => a.user_id === u.id)).map(u => `
							                                        <option value="${u.id}">${u.prenom} ${u.nom} (${u.role})</option>
							                                    `).join('')}
							                                </select>
							                                <button onclick="UI.doAssign(${campaignId})" class="btn-glow">Affecter</button>
							                            </div>
							                        </div>
							                    </div>
							                `;
							                
							                saveBtn.innerText = "Terminer";
							                saveBtn.onclick = () => this.closeModal();
							                container.classList.remove('hidden');
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async doAssign(campaignId) {
							            const userId = document.getElementById('assign-user-select').value;
							            if(!userId) return;
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/campaigns/${campaignId}/assign/${userId}`, {
							                    method: 'POST',
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                if(res.ok) {
							                    App.addActivity("Membre affect√©");
							                    this.manageAssignments(campaignId);
							                } else {
							                    const data = await res.json();
							                    throw new Error(data.error);
							                }
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async unassignUser(assignmentId, campaignId) {
							            if(!confirm("Retirer ce membre ?")) return;
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/assignments/${assignmentId}`, {
							                    method: 'DELETE',
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                if(res.ok) {
							                    App.addActivity("Membre retir√©");
							                    this.manageAssignments(campaignId);
							                }
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async deleteUser(id) {
							            if(!confirm("‚ö†Ô∏è Supprimer ce membre ?")) return;
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/users/${id}?t=` + Date.now(), {
							                    method: 'DELETE',
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                if (res.ok) {
							                    App.addActivity("Membre supprim√©");
							                    await App.loadUsers();
							                } else {
							                    const data = await res.json();
							                    throw new Error(data.error || "Action impossible");
							                }
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async validateUser(id) {
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/users/${id}`, {
							                    method: 'PUT',
							                    headers: { 
							                        'Content-Type': 'application/json',
							                        'Authorization': `Bearer ${App.token}` 
							                    },
							                    body: JSON.stringify({ status: 'active' })
							                });
							                if (res.ok) {
							                    App.addActivity("Nouvel utilisateur valid√©");
							                    await App.loadUsers();
							                } else {
							                    throw new Error("Erreur lors de la validation");
							                }
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        // --- GESTION CONTACTS ---
							        async showContactModal(existingData = null) {
							            const container = document.getElementById('modal-container');
							            const title = document.getElementById('modal-title');
							            const body = document.getElementById('modal-body');
							            const saveBtn = document.getElementById('modal-save');
							
							            // On r√©cup√®re les campagnes si on est en cr√©ation "globale" (hors vue contact filtr√©e)
							            let campaigns = [];
							            if (!existingData && !App.currentCampaignId) {
							                App.showLoader(true);
							                try {
							                    const res = await fetch('/api/management/campaigns', {
							                        headers: { 'Authorization': `Bearer ${App.token}` }
							                    });
							                    campaigns = await res.json();
							                } catch(e) { console.error(e); }
							                finally { App.showLoader(false); }
							            }
							
							            title.innerText = existingData ? "Modifier le Contact" : "Ajouter un Contact";
							            
							            let campaignSelector = '';
							            if (!existingData && !App.currentCampaignId) {
							                campaignSelector = `
							                    <div class="input-group">
							                        <label>Campagne de destination</label>
							                        <select id="m-contact-campaign-id" class="modal-select">
							                            <option value="">S√©lectionner une campagne...</option>
							                            ${campaigns.map(c => `<option value="${c.id}">${c.nom}</option>`).join('')}
							                        </select>
							                    </div>
							                `;
							            }
							
							            body.innerHTML = `
							                <div class="animate-fade-in">
							                    <input type="hidden" id="m-contact-id" value="${existingData ? existingData.id : ''}">
							                    ${campaignSelector}
							                    <div class="modal-grid">
							                        <div class="input-group">
							                            <label>Nom Complet</label>
							                            <input type="text" id="m-contact-nom" value="${existingData ? existingData.nom : ''}" placeholder="M. Jean Durand">
							                        </div>
							                        <div class="input-group">
							                            <label>T√©l√©phone</label>
							                            <input type="text" id="m-contact-tel" value="${existingData ? existingData.telephone : ''}" placeholder="06XXXXXXXX">
							                        </div>
							                    </div>
							                    <div class="input-group">
							                        <label>Email</label>
							                        <input type="email" id="m-contact-email" value="${existingData ? (existingData.email || '') : ''}" placeholder="jean.durand@example.com">
							                    </div>
							                    <div class="modal-grid">
							                        <div class="input-group">
							                            <label>Source</label>
							                            <input type="text" id="m-contact-source" value="${existingData ? (existingData.source || 'manuel') : 'manuel'}" placeholder="Ex: Site Web, LinkedIn">
							                        </div>
							                        <div class="input-group">
							                            <label>Statut</label>
							                            <select id="m-contact-status" class="modal-select">
							                                <option value="nouveau" ${existingData && existingData.status === 'nouveau' ? 'selected' : ''}>Nouveau</option>
							                                <option value="en_cours" ${existingData && existingData.status === 'en_cours' ? 'selected' : ''}>En cours</option>
							                                <option value="termine" ${existingData && existingData.status === 'termine' ? 'selected' : ''}>Termin√©</option>
							                            </select>
							                        </div>
							                    </div>
							                </div>
							            `;
							            
							            saveBtn.className = "btn-modal-save";
							            saveBtn.innerText = existingData ? "Enregistrer les modifications" : "Cr√©er le contact";
							            saveBtn.onclick = () => this.saveContact(existingData ? 'PUT' : 'POST');
							            container.classList.remove('hidden');
							        },
							
							        async saveContact(method) {
							            const id = document.getElementById('m-contact-id').value;
							            const campaignSelect = document.getElementById('m-contact-campaign-id');
							            const targetCampaignId = campaignSelect ? campaignSelect.value : App.currentCampaignId;
							
							            const payload = {
							                nom: document.getElementById('m-contact-nom').value,
							                telephone: document.getElementById('m-contact-tel').value,
							                email: document.getElementById('m-contact-email').value,
							                source: document.getElementById('m-contact-source').value,
							                status: document.getElementById('m-contact-status').value
							            };
							
							            if (!payload.nom || !payload.telephone) {
							                alert("‚ö†Ô∏è Le nom et le t√©l√©phone sont obligatoires.");
							                return;
							            }
							
							            if (method === 'POST' && !targetCampaignId) {
							                alert("‚ö†Ô∏è Veuillez s√©lectionner une campagne.");
							                return;
							            }
							
							            const url = method === 'PUT' ? `/api/management/contacts/${id}` : `/api/management/campaigns/${targetCampaignId}/contacts`;
							
							            App.showLoader(true);
							            try {
							                const res = await fetch(url, {
							                    method: method,
							                    headers: { 
							                        'Content-Type': 'application/json', 
							                        'Authorization': `Bearer ${App.token}`
							                    },
							                    body: JSON.stringify(payload)
							                });
							                
							                if (res.ok) {
							                    this.closeModal();
							                    App.addActivity(`Contact "${payload.nom}" enregistr√©`);
							                    if (App.currentCampaignId) {
							                        App.loadCampaignContacts(App.currentCampaignId);
							                    } else {
							                        App.switchView('contacts'); // Aller voir les contacts
							                    }
							                } else {
							                    const data = await res.json();
							                    throw new Error(data.error || "Erreur lors de la sauvegarde du contact");
							                }
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async editContact(id) {
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/contacts/${id}`, {
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                const contact = await res.json();
							                this.showContactModal(contact);
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        },
							
							        async deleteContact(id) {
							            if(!confirm("‚ö†Ô∏è Supprimer ce contact ?")) return;
							            App.showLoader(true);
							            try {
							                const res = await fetch(`/api/management/contacts/${id}`, {
							                    method: 'DELETE',
							                    headers: { 'Authorization': `Bearer ${App.token}` }
							                });
							                if (res.ok) {
							                    App.addActivity("Contact supprim√©");
							                    App.loadCampaignContacts(App.currentCampaignId);
							                } else {
							                    throw new Error("Erreur lors de la suppression");
							                }
							            } catch (err) { alert(err.message); }
							            finally { App.showLoader(false); }
							        }
							    };
							
							    App.init();
							</script>
							{% endblock %}
