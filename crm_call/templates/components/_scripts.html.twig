<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	const App = {
token: localStorage.getItem('zanova_token'),
theme: localStorage.getItem('zanova_theme') || 'dark',
isSidebarCollapsed: localStorage.getItem('sidebar_collapsed') === 'true',
currentRole: null, // Initialis√© par bootApp/renderUI
userData: null,
currentCampaignId: null,
currentContact: null,
callInterval: null,
callSeconds: 0,

    showAlert(message, type = 'success') {
        const box = document.createElement('div');
        box.className = `alert-box ${type}`;
        const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
        box.innerHTML = `<i class="fas fa-${icon}"></i> <span>${message}</span>`;
        document.body.appendChild(box);
        setTimeout(() => {
            box.style.animation = 'slideInRight 0.5s reverse forwards';
            setTimeout(() => box.remove(), 500);
        }, 3000);
    },

init() {
this.applyTheme();
this.applySidebarState();
this.bindEvents();
if (this.token) {
this.bootApp();
}
},

bindEvents() {
console.log("App: Binding events...");
const safeBind = (id, event, fn) => {
const el = document.getElementById(id);
if (el) 
el.addEventListener(event, fn);
 else 
console.warn(`App: Element #${id} not found for binding ${event}`);



};

safeBind('btn-login', 'click', () => this.login());
safeBind('btn-logout', 'click', () => this.confirmLogout());
safeBind('sidebar-toggle', 'click', () => this.toggleSidebar());
safeBind('mobile-menu-toggle', 'click', () => this.toggleMobileSidebar());

// Navigation
document.querySelectorAll('.nav-item').forEach(item => {
item.addEventListener('click', (e) => {
e.preventDefault();
console.log("App: Navigating to", item.dataset.target);
document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
item.classList.add('active');
this.switchView(item.dataset.target);
const sb = document.getElementById('sidebar');
if (sb) 
sb.classList.remove('mobile-open');



});
});
},

toggleTheme() {
this.theme = this.theme === 'dark' ? 'light' : 'dark';
localStorage.setItem('zanova_theme', this.theme);
this.applyTheme();
},

applyTheme() {
document.documentElement.setAttribute('data-theme', this.theme);
},

toggleSidebar() {
this.isSidebarCollapsed = !this.isSidebarCollapsed;
localStorage.setItem('sidebar_collapsed', this.isSidebarCollapsed);
this.applySidebarState();
},

applySidebarState() {
const sb = document.getElementById('sidebar');
if (this.isSidebarCollapsed) 
sb.classList.add('collapsed');
 else 
sb.classList.remove('collapsed');



},

toggleMobileSidebar() {
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('sidebar-overlay');

sidebar.classList.toggle('mobile-open');
overlay.classList.toggle('active');

if (sidebar.classList.contains('mobile-open')) {
document.body.style.overflow = 'hidden';
} else {
document.body.style.overflow = '';
}
},

async login() {
console.log("App: Login attempt...");
const emailEl = document.getElementById('email');
const passwordEl = document.getElementById('password');
if (! emailEl || ! passwordEl) {
console.error("App: Login fields not found");
return;
}

this.showLoader(true);
const errBox = document.getElementById('auth-error');
if (errBox) 
errBox.classList.add('hidden');



try {
const email = emailEl.value;
const password = passwordEl.value;
console.log("App: Sending request to /api/login_check for", email);

const response = await fetch('/api/login_check', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(
{email, password}
)
});

console.log("App: Response status:", response.status);
const data = await response.json();

if (response.ok) {
console.log("App: Login successful, booting app...");
this.token = data.token;
localStorage.setItem('zanova_token', this.token);
await this.bootApp();
} else {
console.error("App: Login failed:", data.message || "Identifiants invalides");
throw new Error(data.message || "Identifiants invalides");
}
} catch (err) {
console.error("App: Login error:", err);
if (errBox) {
errBox.innerText = err.message;
errBox.classList.remove('hidden');
} else {
alert(err.message);
}
} finally {
this.showLoader(false);
}
},

async bootApp() {
this.showLoader(true);
try {
const response = await fetch('/api/profile', {
headers: {
'Authorization': `Bearer ${
this.token
}`
}
});
if (! response.ok) 
throw new Error("Expulsion");



const result = await response.json();
this.userData = result.data;
this.renderUI();
document.getElementById('auth-screen').classList.add('hidden');
document.getElementById('main-dashboard').classList.remove('hidden');
this.initializeDashboardData();
} catch (err) {
this.logout();
} finally {
this.showLoader(false);
}
},

renderUI() {
    const isResponsable = this.userData.roles.includes('ROLE_RESPONSABLE');
    const isSupervisor = this.userData.roles.includes('ROLE_SUPERVISEUR');
    const apiRole = this.userData.role_crm; // 'agent', 'responsable', 'superviseur'

    // Si aucun r√¥le n'est m√©moris√© ou si l'utilisateur n'a pas le droit d'√™tre dans ce r√¥le
    if (!this.currentRole || (!isResponsable && this.currentRole === 'admin') || (!isSupervisor && this.currentRole === 'supervisor' && !isResponsable)) {
        this.currentRole = (apiRole === 'responsable') ? 'admin' : (apiRole === 'superviseur' ? 'supervisor' : 'agent');
    }

    const userNameEl = document.getElementById('user-name');
    if (userNameEl) userNameEl.innerText = `${this.userData.prenom} ${this.userData.nom}`;
    
    const userRoleEl = document.getElementById('user-role');
    if (userRoleEl) userRoleEl.innerText = this.userData.role_crm;

    // Le bouton de basculement n'est affich√© que pour les Responsables (pour simulation)
    const btnSwitch = document.getElementById('btn-switch-role');
    if (btnSwitch) {
        btnSwitch.style.display = isResponsable ? 'flex' : 'none';
    }

    const modeIndicator = document.getElementById('mode-indicator');
    const modeText = document.getElementById('mode-text');
    if (modeIndicator && modeText) {
        modeIndicator.style.display = 'flex';
        modeIndicator.className = 'mode-indicator ' + this.currentRole;
        modeText.innerText = 'Mode ' + (this.currentRole === 'admin' ? 'Admin' : (this.currentRole === 'supervisor' ? 'Superviseur' : 'Agent'));
    }

    if (this.currentRole === 'agent') {
        this.applyAgentView();
    } else if (this.currentRole === 'supervisor') {
        this.applySupervisorView();
    } else {
        this.applyAdminView();
    }
},

switchView(target) {
const titles = {
'dashboard': this.currentRole === 'agent' ? 'Mon Espace Agent' : (this.currentRole === 'supervisor' ? 'Supervision' : 'Tableau de bord'),
'statistics': 'Statistiques & Analyse',
'campaigns': 'Campagnes',
'users': '√âquipe & Acc√®s',
'contacts': 'R√©pertoire Contacts'
};

document.getElementById('page-title').innerText = titles[target] || target.charAt(0).toUpperCase() + target.slice(1);
document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));

const viewMapping = {
'dashboard': this.currentRole === 'agent' ? 'agent-overview-view' : (this.currentRole === 'supervisor' ? 'supervisor-overview-view' : 'overview-view'),
'statistics': 'statistics-view',
'campaigns': 'campaigns-view',
'users': 'users-view',
'contacts': 'contacts-view'
};

const activeView = document.getElementById(viewMapping[target] || target + '-view');
if (activeView) {
activeView.classList.remove('hidden');
document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
document.querySelector(`[onclick="App.switchView('${target}')"]`) ?. classList.add('active');

if (target === 'dashboard') {
if (this.currentRole === 'agent') 
this.initializeAgentDashboard();
 else if (this.currentRole === 'supervisor') 
this.initializeSupervisorDashboard();
 else 
this.initializeDashboardData();



} else if (target === 'statistics') 
this.initializeStatistics();
 else if (target === 'campaigns') 
this.loadCampaigns();
 else if (target === 'users') 
this.loadUsers();
 else if (target === 'contacts') 
this.loadContacts();



}
},

async loadContacts() {
    this.addActivity("Chargement du r√©pertoire...");
    this.showLoader(true);
    try {
        const url = this.currentRole === 'agent' ? '/api/agent/campaigns' : '/api/management/campaigns';
        const res = await fetch(url, {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        const campaigns = await res.json();
        const container = document.getElementById('contact-campaign-selector');
        if (!container) return;
        
        container.innerHTML = campaigns.map(c => `
            <div onclick="App.loadCampaignContacts(${c.id}, this)" class="activity-item contact-campaign-item" style="cursor:pointer; transition:0.2s;">
                <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-lg p-2 me-2">
                    <i class="fas fa-bullseye"></i>
                </div>
                <strong>${c.nom}</strong>
            </div>
        `).join('');

        // Auto-select first campaign
        if (campaigns.length > 0) {
            const firstItem = container.querySelector('.contact-campaign-item');
            if (firstItem) this.loadCampaignContacts(campaigns[0].id, firstItem);
        }
    } catch (err) {
        console.error(err);
    } finally {
        this.showLoader(false);
    }
},

async loadCampaignContacts(campaignId, el = null) {
    if (el) {
        document.querySelectorAll('.contact-campaign-item').forEach(item => {
            item.classList.remove('bg-primary-50', 'border-primary');
            item.style.background = '';
        });
        el.classList.add('bg-primary-50', 'border-primary');
        el.style.background = 'rgba(59, 130, 246, 0.05)';
    }
    this.showLoader(true);
    try {
        const url = this.currentRole === 'agent' 
            ? `/api/agent/campaigns/${campaignId}/contacts` 
            : `/api/management/campaigns/${campaignId}/contacts`;
            
        const res = await fetch(url, {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        const contacts = await res.json();
const tbody = document.getElementById('contact-list-body');

                tbody.innerHTML = contacts.length ? contacts.map(c => `
                    <tr>
                        <td>
                            <div class="fw-bold text-gray-800">${c.nom}</div>
                            <small class="text-gray-500">ID: ${c.id}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-3">
                                <span class="fw-semibold">${c.telephone}</span>
                                <div class="click-to-call-btns">
                                    <a href="tel:${c.telephone}" class="btn-action" title="Appeler (MicroSIP / Syst√®me)" onclick="App.showAlert('Appel via MicroSIP...')">
                                        <i class="fas fa-phone text-success"></i>
                                    </a>
                                    <a href="callto:${c.telephone}" class="btn-action" title="Appeler (Zoiper / VoIP)" onclick="App.showAlert('Appel via Zoiper...')">
                                        <i class="fas fa-headset text-info"></i>
                                    </a>
                                </div>
                            </div>
                            <small class="text-gray-400 d-block">${c.email || '-'}</small>
                        </td>
                        <td><span class="badge badge-neutral">${c.source}</span></td>
                        <td><span class="badge ${c.status === 'nouveau' ? 'badge-primary' : 'badge-success'}">${c.status}</span></td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align:center; padding:3rem; color:var(--text-dim);">Aucun contact trouv√© dans cette campagne.</td></tr>';
} catch (err) {
alert(err.message);
} finally {
this.showLoader(false);
}
},

async loadCampaigns() {
this.showLoader(true);
try {
const res = await fetch('/api/management/campaigns?t=' + Date.now(), {
method: 'GET',
cache: 'no-store',
headers: {
'Authorization': `Bearer ${
this.token
}`,
'Accept': 'application/json'
}
});
const data = await res.json();
if (!Array.isArray(data)) 
throw new Error(data.message || "R√©ponse invalide du serveur");



const tbody = document.getElementById('campaign-list-body');
tbody.innerHTML = data.length ? data.map(c => `
                    <tr>
                        <td><strong>${
c.nom
}</strong><br><small style="color:var(--text-dim)">ID: ${
c.id
}</small></td>
                        <td>${
c.date_debut || '-'
} / ${
c.date_fin || '-'
}</td>
                        <td>${
c.responsable || 'Non assign√©'
}</td>
                        <td><span class='badge'>${
c.contacts_count
}</span></td>
                        <td>
                            <div class="action-btns">
                                <button onclick="UI.manageAssignments(${
c.id
})" class="btn-action" title="Affectations">ü§ù</button>
                                <button onclick="UI.manageFields(${
c.id
})" class="btn-action" title="Formulaire">üìã</button>
                                <button onclick="UI.editCampaign(${
c.id
})" class="btn-action">‚úèÔ∏è</button>
                                <button onclick="UI.deleteCampaign(${
c.id
})" class="btn-action delete">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="5" style="text-align:center; padding: 2rem;">Aucune campagne trouv√©e</td></tr>';
} catch (err) {
alert("Erreur: " + err.message);
} finally {
this.showLoader(false);
}
},

async loadUsers() {
this.showLoader(true);
try {
const res = await fetch('/api/management/users?t=' + Date.now(), {
method: 'GET',
cache: 'no-store',
headers: {
'Authorization': `Bearer ${
this.token
}`,
'Accept': 'application/json'
}
});
const data = await res.json();
if (!Array.isArray(data)) 
throw new Error(data.message || "R√©ponse invalide du serveur");



const tbody = document.getElementById('user-list-body');
tbody.innerHTML = data.map(u => {
const roleClass = u.role === 'responsable' ? 'badge-admin' : (u.role === 'superviseur' ? 'badge-primary' : 'badge-neutral');
const statusClass = u.status === 'active' ? 'badge-success' : 'badge-danger';
return `
                        <tr>
                            <td><div style="display:flex; align-items:center; gap:12px;">
                                <div class="user-avatar" style="width:32px; height:32px; font-size:0.8rem;">${
u.prenom[0]
}</div>
                                <strong>${
u.prenom
} ${
u.nom
}</strong>
                            </div></td>
                            <td><span style="color:var(--text-dim); font-size:0.9rem;">${
u.email
}</span></td>
                            <td><span class="badge ${roleClass}">${
u.role
}</span></td>
                            <td><span class="badge ${statusClass}">${
u.status
}</span></td>
                            <td>
                                <div class="action-btns">
                                    <button onclick="UI.manageUserAssignments(${u.id})" class="btn-action" title="Affectations">ü§ù</button>
                                    <button onclick="UI.editUser(${u.id})" class="btn-action">‚úèÔ∏è</button>
                                    <button onclick="UI.deleteUser(${u.id})" class="btn-action delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
}).join('');
} catch (err) {
alert("Erreur: " + err.message);
} finally {
this.showLoader(false);
}
},

showLoader(show) {
document.getElementById('global-loader').classList.toggle('hidden', !show);
},

addActivity(msg) {
const container = document.getElementById('activity-log');
if (! container) 
return;



const empty = container.querySelector('.empty');
if (empty) 
empty.remove();



const item = document.createElement('div');
item.className = 'activity-item';
const now = new Date();
const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
item.innerHTML = `<span class="time">${timeStr}</span> <p class="msg">${msg}</p>`;
container.prepend(item);
},

updateAgentRanking(criteria) {
this.simulateAgentRanking(criteria);
},

simulateAgentRanking(criteria) {
const rankingData = {
calls: [
{
name: 'Martin Dubois',
stats: '45 appels ‚Ä¢ 92% qualification',
score: 45,
avatar: 'MD',
color: 'primary'
}, {
name: 'Sophie Laurent',
stats: '38 appels ‚Ä¢ 88% qualification',
score: 38,
avatar: 'SL',
color: 'success'
}, {
name: 'Thomas Bernard',
stats: '32 appels ‚Ä¢ 85% qualification',
score: 32,
avatar: 'TB',
color: 'info'
}
],
duration: [
{
name: 'Sophie Laurent',
stats: '38 appels ‚Ä¢ 3:45 moyenne',
score: '3:45',
avatar: 'SL',
color: 'success'
}, {
name: 'Martin Dubois',
stats: '45 appels ‚Ä¢ 3:20 moyenne',
score: '3:20',
avatar: 'MD',
color: 'primary'
}, {
name: 'Thomas Bernard',
stats: '32 appels ‚Ä¢ 2:55 moyenne',
score: '2:55',
avatar: 'TB',
color: 'info'
}
],
qualification: [
{
name: 'Martin Dubois',
stats: '45 appels ‚Ä¢ 92% qualification',
score: '92%',
avatar: 'MD',
color: 'primary'
}, {
name: 'Sophie Laurent',
stats: '38 appels ‚Ä¢ 88% qualification',
score: '88%',
avatar: 'SL',
color: 'success'
}, {
name: 'Thomas Bernard',
stats: '32 appels ‚Ä¢ 85% qualification',
score: '85%',
avatar: 'TB',
color: 'info'
}
]
};
const data = rankingData[criteria] || rankingData.calls;
const container = document.getElementById('top-agents');
if (! container) 
return;



container.innerHTML = data.map((agent, index) => `
                <div class="d-flex align-items-center p-3 mb-2 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-200">
                    <div class="badge bg-${
agent.color
} text-white rounded-circle p-2 me-3">
                        <span class="fw-bold">${
index + 1
}</span>
                    </div>
                    <div class="avatar bg-${
agent.color
} bg-opacity-10 text-${
agent.color
} rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <span class="fw-bold">${
agent.avatar
}</span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-semibold text-gray-800 dark:text-gray-200">${
agent.name
}</h6>
                        <small class="text-gray-500 dark:text-gray-400">${
agent.stats
}</small>
                    </div>
                    <div class="text-end">
                        <div class="h5 mb-0 fw-bold text-${
agent.color
}">${
agent.score
}</div>
                    </div>
                </div>
            `).join('');
},

filterActivity(type) {
document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
if (event.target.classList) 
event.target.classList.add('active');



this.filterActivitiesByType(type);
},

filterActivitiesByType(type) {
const activities = {
all: [
{
icon: 'fa-phone',
type: 'call',
title: 'Appel termin√© - Agent 1',
details: 'Contact: +33612345678 ‚Ä¢ Dur√©e: 3:45',
time: 'Il y a 2 min',
alert: false,
color: 'primary'
}, {
icon: 'fa-check-circle',
type: 'qualification',
title: 'Qualification - Agent 2',
details: 'Statut: Accept√© ‚Ä¢ Campagne: Vente 2024',
time: 'Il y a 5 min',
alert: false,
color: 'success'
}, {
icon: 'fa-exclamation-triangle',
type: 'alert',
title: 'Alerte - Agent 3',
details: 'Appel d√©passe dur√©e maximale (10 min)',
time: 'Il y a 8 min',
alert: true,
color: 'danger'
}
],
calls: [
{
icon: 'fa-phone',
type: 'call',
title: 'Appel termin√© - Agent 1',
details: 'Contact: +33612345678 ‚Ä¢ Dur√©e: 3:45',
time: 'Il y a 2 min',
alert: false,
color: 'primary'
}, {
icon: 'fa-phone',
type: 'call',
title: 'Appel termin√© - Agent 2',
details: 'Contact: +33698765432 ‚Ä¢ Dur√©e: 2:15',
time: 'Il y a 12 min',
alert: false,
color: 'primary'
}
],
qualifications: [
{
icon: 'fa-check-circle',
type: 'qualification',
title: 'Qualification - Agent 2',
details: 'Statut: Accept√© ‚Ä¢ Campagne: Vente 2024',
time: 'Il y a 5 min',
alert: false,
color: 'success'
}, {
icon: 'fa-times-circle',
type: 'qualification',
title: 'Qualification - Agent 1',
details: 'Statut: Refus√© ‚Ä¢ Campagne: Satisfaction',
time: 'Il y a 18 min',
alert: false,
color: 'danger'
}
]
};
const container = document.getElementById('activity-log');
if (! container) 
return;



const data = activities[type] || activities.all;
container.innerHTML = data.map(activity => `
                <div class="d-flex align-items-start p-3 mb-2 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-200 ${
activity.alert ? 'border border-' + activity.color + '-200' : ''
}">
                    <div class="icon-box bg-${
activity.color
} bg-opacity-10 text-${
activity.color
} rounded-lg p-2 me-3">
                        <i class="fas ${
activity.icon
}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-semibold text-gray-800 dark:text-gray-200">${
activity.title
}</h6>
                        <small class="text-gray-500 dark:text-gray-400">${
activity.details
}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-gray-400 dark:text-gray-500">${
activity.time
}</small>
                    </div>
                </div>
            `).join('');
},

refreshCampaigns() {
this.simulateCampaignRefresh();
},

simulateCampaignRefresh() {
const campaigns = [
{
name: 'Vente Q1 2024',
stats: '48% ‚Ä¢ 125/250 contacts',
progress: 48,
color: 'primary'
}, {
name: 'Satisfaction Client',
stats: '82% ‚Ä¢ 95/114 contacts',
progress: 82,
color: 'success'
}, {
name: 'Prospection Printemps',
stats: '23% ‚Ä¢ 45/195 contacts',
progress: 23,
color: 'warning'
}
];
const container = document.getElementById('active-campaigns');
if (! container) 
return;



container.innerHTML = campaigns.map(campaign => `
                <div class="p-3 mb-3 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-200">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 fw-semibold text-gray-800 dark:text-gray-200">${
campaign.name
}</h6>
                        <span class="badge bg-${
campaign.color
} bg-opacity-10 text-${
campaign.color
}">${
campaign.progress
}%</span>
                    </div>
                    <small class="text-gray-500 dark:text-gray-400 d-block mb-2">${
campaign.stats
}</small>
                    <div class="progress bg-gray-200 dark:bg-gray-600 h-2 rounded">
                        <div class="progress-bar bg-${
campaign.color
}" style="width: ${
campaign.progress
}%"></div>
                    </div>
                </div>
            `).join('');
if (event && event.target) {
const btn = event.target.closest('button') || event.target;
const icon = btn.querySelector('i');
if (icon) {
icon.classList.add('fa-spin');
setTimeout(() => icon.classList.remove('fa-spin'), 500);
}
}
},

refreshSupervision() {
this.loadSupervisorRealtime();
this.loadSupervisorAlerts();
},

initializeSupervisionData() {
const agents = [
{
name: 'Agent 1',
status: 'available',
duration: '00:00',
callStatus: 'En attente',
alert: false
}, {
name: 'Agent 2',
status: 'in-call',
duration: '02:45',
callStatus: 'En cours',
alert: false
}, {
name: 'Agent 3',
status: 'in-call',
duration: '08:30',
callStatus: 'D√©passement',
alert: true
}
];
const container = document.getElementById('realtime-supervision');
if (! container) 
return;



container.innerHTML = agents.map((agent, index) => `
                <div class="d-flex align-items-center p-3 mb-2 bg-gray-50 dark:bg-gray-700 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-200 ${
agent.alert ? 'border border-danger' : ''
}">
                    <div class="avatar bg-${
agent.status === 'in-call' ? 'success' : 'primary'
} bg-opacity-10 text-${
agent.status === 'in-call' ? 'success' : 'primary'
} rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <span class="fw-bold">${
String.fromCharCode(65 + index)
}</span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-semibold text-gray-800 dark:text-gray-200">${
agent.name
}</h6>
                        <span class="badge bg-${
agent.status === 'in-call' ? 'success' : 'primary'
} bg-opacity-10 text-${
agent.status === 'in-call' ? 'success' : 'primary'
}">
                            ${
agent.status === 'in-call' ? 'En appel' : 'Disponible'
}
                        </span>
                    </div>
                    <div class="text-end">
                        <div class="h6 mb-0 fw-bold ${
agent.alert ? 'text-danger' : 'text-gray-800 dark:text-gray-200'
}">${
agent.duration
}</div>
                        <small class="${
agent.alert ? 'text-danger' : 'text-gray-500 dark:text-gray-400'
}">${
agent.callStatus
}</small>
                    </div>
                </div>
            `).join('');
},

initializeStatistics() {
const filter = document.getElementById('time-filter');
if (filter) {
filter.addEventListener('change', (e) => {
if (e.target.value === 'custom') 
document.getElementById('custom-date-filter').classList.remove('hidden');
 else {
document.getElementById('custom-date-filter').classList.add('hidden');
this.loadStatisticsData(e.target.value);
}
});
}
this.loadStatisticsData('week');
this.initializeCharts();
this.renderRoleSpecificStats();
},

loadStatisticsData(period) {
const mockData = {
today: {
totalCalls: 45,
avgDuration: '3:25',
conversion: 12,
quality: 85
},
week: {
totalCalls: 287,
avgDuration: '4:12',
conversion: 18,
quality: 88
},
month: {
totalCalls: 1245,
avgDuration: '3:58',
conversion: 15,
quality: 86
}
};
const data = mockData[period] || mockData.week;
this.animateCounter('stat-total-calls', data.totalCalls);
const durationEl = document.getElementById('stat-avg-duration');
if (durationEl) 
durationEl.textContent = data.avgDuration;



this.animateCounter('stat-conversion', data.conversion, '%');
this.animateCounter('stat-quality', data.quality, '/100');
this.updateCharts(period);
},

initializeCharts() {
const callsEl = document.getElementById('calls-chart');
if (callsEl) {
const callsCtx = callsEl.getContext('2d');
this.callsChart = new Chart(callsCtx, {
type: 'line',
data: {
labels: [
'Lun',
'Mar',
'Mer',
'Jeu',
'Ven',
'Sam',
'Dim'
],
datasets: [
{
label: 'Appels r√©ussis',
data: [
65,
78,
90,
81,
96,
85,
70
],
borderColor: 'rgb(59, 130, 246)',
backgroundColor: 'rgba(59, 130, 246, 0.1)',
tension: 0.4
}, {
label: 'Appels manqu√©s',
data: [
28,
32,
25,
30,
22,
28,
35
],
borderColor: 'rgb(239, 68, 68)',
backgroundColor: 'rgba(239, 68, 68, 0.1)',
tension: 0.4
}
]
},
options: {
responsive: true,
maintainAspectRatio: false
}
});
}
const statusEl = document.getElementById('status-chart');
if (statusEl) {
const statusCtx = statusEl.getContext('2d');
this.statusChart = new Chart(statusCtx, {
type: 'doughnut',
data: {
labels: [
'R√©ussis', 'Manqu√©s', 'En cours', 'Qualifi√©s'
],
datasets: [
{
data: [
287, 95, 23, 156
],
backgroundColor: [
'rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(99, 102, 241, 0.8)'
],
borderWidth: 0
}
]
},
options: {
responsive: true,
maintainAspectRatio: false
}
});
}
},

updateCharts(period) {
const chartData = {
today: {
calls: [
45,
38,
52,
41,
48,
35,
28
],
missed: [
12,
15,
8,
18,
10,
14,
20
]
},
week: {
calls: [
65,
78,
90,
81,
96,
85,
70
],
missed: [
28,
32,
25,
30,
22,
28,
35
]
},
month: {
calls: [
125,
145,
160,
138,
175,
165,
140
],
missed: [
55,
62,
48,
58,
42,
52,
65
]
}
};
if (this.callsChart && chartData[period]) {
this.callsChart.data.datasets[0].data = chartData[period].calls;
this.callsChart.data.datasets[1].data = chartData[period].missed;
this.callsChart.update();
}
},

renderRoleSpecificStats() {
const container = document.getElementById('role-specific-stats');
if (! container) 
return;



const userRole = this.userData ?. role_crm || 'agent';
let content = '';
switch (userRole) {
case 'responsable': content = this.renderResponsableStats();
break;
case 'superviseur': content = this.renderSuperviseurStats();
break;
case 'agent': content = this.renderAgentStats();
break;
default: content = '<div class="alert alert-warning">R√¥le non reconnu</div>';
}
container.innerHTML = content;
},

renderResponsableStats() {
return `
                <div class="row g-4">
                    <div class="col-xl-6">
                        <div class="card bg-white dark:bg-gray-800 border-0 shadow-lg rounded-2xl">
                            <div class="card-header bg-transparent border-gray-100 dark:border-gray-700 px-4 py-3">
                                <h5 class="card-title mb-0 fw-bold text-gray-800 dark:text-gray-100"><i class="fas fa-bullseye text-primary me-2"></i>Performance par Campagne</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead><tr><th>Campagne</th><th>Appels</th><th>Conversion</th><th>Score</th></tr></thead>
                                        <tbody>
                                            <tr><td><strong>Vente Q1</strong></td><td>245</td><td><span class="badge bg-success">22%</span></td><td><span class="badge bg-primary">87/100</span></td></tr>
                                            <tr><td><strong>Satisfaction</strong></td><td>189</td><td><span class="badge bg-warning">15%</span></td><td><span class="badge bg-info">82/100</span></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-6">
                        <div class="card bg-white dark:bg-gray-800 border-0 shadow-lg rounded-2xl">
                            <div class="card-header bg-transparent border-gray-100 dark:border-gray-700 px-4 py-3">
                                <h5 class="card-title mb-0 fw-bold text-gray-800 dark:text-gray-100"><i class="fas fa-trophy text-warning me-2"></i>Classement des Agents</h5>
                            </div>
                            <div class="card-body p-4">${
this.renderTopAgentsList()
}</div>
                        </div>
                    </div>
                </div>
            `;
},

renderSuperviseurStats() {
return `<div class="row g-4"><div class="col-12"><div class="card bg-white dark:bg-gray-800 border-0 shadow-lg rounded-2xl"><div class="card-header bg-transparent border-gray-100 dark:border-gray-700 px-4 py-3"><h5 class="card-title mb-0 fw-bold text-gray-800 dark:text-gray-100"><i class="fas fa-chart-line text-info me-2"></i>Campagne: Vente Q1 2024</h5></div><div class="card-body p-4"><div class="row g-4"><div class="col-md-3 text-center"><h4 class="fw-bold text-primary">245</h4><small class="text-gray-500">Total Appels</small></div><div class="col-md-3 text-center"><h4 class="fw-bold text-success">22%</h4><small class="text-gray-500">Taux Conversion</small></div></div></div></div></div></div>`;
},

renderAgentStats() {
return `<div class="row g-4"><div class="col-12"><div class="card bg-white dark:bg-gray-800 border-0 shadow-lg rounded-2xl"><div class="card-header bg-transparent border-gray-100 dark:border-gray-700 px-4 py-3"><h5 class="card-title mb-0 fw-bold text-gray-800 dark:text-gray-100"><i class="fas fa-user text-primary me-2"></i>Mes Performances</h5></div><div class="card-body p-4"><div class="row g-4"><div class="col-md-6"><h6 class="text-gray-600 dark:text-gray-400 mb-3">Aujourd'hui</h6><div class="d-flex justify-content-between"><span>Appels</span><strong>12</strong></div></div></div></div></div></div></div>`;
},

renderTopAgentsList() {
const agents = [
{
name: 'Martin Dubois',
calls: 45,
score: 92,
rank: 1
}, {
name: 'Sophie Laurent',
calls: 38,
score: 88,
rank: 2
}
];
return agents.map(agent => `<div class="d-flex align-items-center p-3 mb-2 bg-gray-50 dark:bg-gray-700 rounded-xl"><div class="badge bg-primary text-white rounded-circle p-2 me-3">${
agent.rank
}</div><div class="flex-grow-1"><h6 class="mb-1 fw-semibold">${
agent.name
}</h6><small class="text-gray-500">${
agent.calls
} appels</small></div><div class="text-end"><div class="h6 mb-0 fw-bold text-primary">${
agent.score
}/100</div></div></div>`).join('');
},

renderAgentsByCampaign() {
const agents = [{
name: 'Agent 1',
calls: 45,
conversion: 20,
status: 'online'
}];
return `<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Agent</th><th>Appels</th><th>Conversion</th><th>Statut</th></tr></thead><tbody>${
agents.map(agent => `<tr><td>${
agent.name
}</td><td>${
agent.calls
}</td><td><span class="badge bg-success">${
agent.conversion
}%</span></td><td><span class="badge bg-success">En ligne</span></td></tr>`).join('')
}</tbody></table></div>`;
},

refreshStatistics() {
const period = document.getElementById('time-filter').value;
this.loadStatisticsData(period);
if (event) {
const btn = event.target.closest('button');
const icon = btn.querySelector('i');
if (icon) {
icon.classList.add('fa-spin');
setTimeout(() => icon.classList.remove('fa-spin'), 500);
}
}
},

applyCustomDateFilter() {
const start = document.getElementById('start-date').value;
const end = document.getElementById('end-date').value;
if (start && end) 
this.loadStatisticsData('custom');
 else 
alert('Veuillez s√©lectionner une date de d√©but et de fin');



},

async initializeDashboardData() {
    try {
        const res = await fetch('/api/management/stats', {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        const stats = await res.json();

        this.animateCounter('stat-campaigns', stats.campaignsCount || 0);
        this.animateCounter('stat-agents', stats.agentsCount || 0);
        this.animateCounter('stat-calls', stats.callsToday || 0);
        this.animateCounter('stat-qualification', stats.qualificationRate || 0, '%');

        const cp = document.getElementById('campaigns-progress');
        if (cp) cp.textContent = (stats.campaignsProgress || 0) + '% de progression';

        const as = document.getElementById('agents-status');
        if (as) as.textContent = `${stats.agentsOnline || 0} en appel / ${stats.agentsCount - stats.agentsOnline || 0} disponible`;

        this.animateProgressBar('campaigns-progress-bar', stats.campaignsProgress || 0);
        this.animateProgressBar('agents-progress-bar', (stats.agentsOnline / stats.agentsCount * 100) || 0);
        
        this.simulateAgentRanking('calls');
        this.initializeSupervisionData();
        this.startRealtimeSupervision();
    } catch (err) { console.error("Global Stats Error:", err); }
},

animateCounter(elementId, target, suffix = '') {
const element = document.getElementById(elementId);
if (! element) 
return;



let current = 0;
const increment = target / 50;
const timer = setInterval(() => {
current += increment;
if (current >= target) {
current = target;
clearInterval(timer);
}
element.textContent = Math.floor(current) + suffix;
}, 30);
},

animateProgressBar(elementId, targetWidth) {
const element = document.getElementById(elementId);
if (! element) 
return;



setTimeout(() => {
element.style.width = targetWidth + '%';
element.style.transition = 'width 1.5s ease-out';
}, 500);
},

startRealtimeSupervision() {
setInterval(() => this.updateSupervisionData(), 5000);
},

updateSupervisionData() {
document.querySelectorAll('.supervision-item').forEach((item, index) => {
const durationElement = item.querySelector('.call-duration');
if (durationElement && ! durationElement.classList.contains('warning')) {
const currentTime = durationElement.textContent;
const [m, s] = currentTime.split(':').map(Number);
const total = m * 60 + s + 5;
durationElement.textContent = `${
Math.floor(total / 60).toString().padStart(2, '0')
}:${
(total % 60).toString().padStart(2, '0')
}`;
if (total > 600) {
durationElement.classList.add('warning');
item.classList.add('alert-long-call');
}
}
});
},

confirmLogout() {
    const c = document.getElementById('modal-container');
    document.getElementById('modal-title').innerText = "Confirmation de d√©connexion";
    document.getElementById('modal-body').innerHTML = `
        <div class="text-center py-4">
            <div class="icon-box bg-danger bg-opacity-10 text-danger rounded-circle p-4 d-inline-block mb-3" style="width:80px; height:80px;">
                <i class="fas fa-sign-out-alt fa-3x"></i>
            </div>
            <h4 class="fw-bold mb-2">Souhaitez-vous vous d√©connecter ?</h4>
            <p class="text-gray-500">Toutes les sessions d'appels en cours seront interrompues.</p>
        </div>
    `;
    const s = document.getElementById('modal-save');
    s.innerHTML = '<i class="fas fa-power-off me-2"></i>Se d√©connecter';
    s.className = 'btn btn-danger py-2 px-4 rounded-xl';
    s.onclick = () => this.logout();
    
    // Afficher le bouton save (au cas o√π il √©tait masqu√©)
    s.classList.remove('hidden');
    c.classList.remove('hidden');
},

logout() {
    this.showLoader(true);
    // Overlay de d√©connexion sp√©cifique
    const overlay = document.createElement('div');
    overlay.className = 'loader-overlay';
    overlay.innerHTML = `
        <div class="spinner"></div>
        <p>D√©connexion en cours...</p>
    `;
    document.body.appendChild(overlay);

    setTimeout(() => {
        localStorage.removeItem('zanova_token');
        localStorage.removeItem('zanova_current_role');
        location.reload();
    }, 800);
},

switchUserRole() {
    if (!this.userData.roles.includes('ROLE_RESPONSABLE')) {
        console.error("Acc√®s refus√© : Seuls les responsables peuvent basculer de r√¥le.");
        return;
    }

    if (this.currentRole === 'admin') this.currentRole = 'agent';
    else if (this.currentRole === 'agent') this.currentRole = 'supervisor';
    else this.currentRole = 'admin';

    localStorage.setItem('zanova_current_role', this.currentRole);
    this.renderUI();
    this.switchView('dashboard');
},

applySupervisorView() {
document.querySelectorAll('.restricted-responsable').forEach(el => el.classList.add('hidden'));
document.querySelectorAll('.nav-item').forEach(item => {
const oc = item.getAttribute('onclick');
if (oc && oc.includes('users')) 
item.style.display = 'none';
 else 
item.style.display = 'flex';



});
},

initializeSupervisorDashboard() {
setTimeout(() => {
this.loadSupervisorRealtime();
this.loadSupervisorAlerts();
this.loadSupervisorRanking();
this.loadQualificationStats();
this.loadSupervisorCampaigns();
}, 500);
},

loadSupervisorRealtime() {
const agents = [{
name: 'Martin Dubois',
status: 'en_appel',
duration: '3m45s',
qualification: 'en_attente',
campaign: 'Vente Printemps',
alert: true
}];
const container = document.getElementById('supervisor-realtime');
if (! container) 
return;



container.innerHTML = agents.map(agent => `<div class="supervision-item d-flex align-items-center p-3 border rounded mb-2 ${
agent.alert ? 'border-warning bg-warning-50' : ''
}"><div class="agent-avatar me-3">${
agent.name[0]
}</div><div class="flex-1"><h6 class="mb-0">${
agent.name
}</h6><span class="badge ${
agent.status === 'en_appel' ? 'bg-success' : 'bg-secondary'
}">${
agent.status
}</span></div></div>`).join('');
},

loadSupervisorAlerts() {
const alerts = [{
type: 'danger',
message: 'D√©passement dur√©e',
agent: 'Martin Dubois',
time: '2m'
}];
const container = document.getElementById('supervisor-alerts');
if (! container) 
return;



document.getElementById('supervisor-alert-count').innerText = alerts.length;
container.innerHTML = alerts.map(a => `<div class="alert-item p-2 mb-2 border rounded bg-${
a.type
}-50"><p class="small mb-0">${
a.message
}</p></div>`).join('');
},

loadSupervisorRanking() {
const ranking = [{
name: 'Martin Dubois',
stats: '45 appels',
score: 45,
avatar: 'MD',
color: 'primary'
}];
const container = document.getElementById('supervisor-top-agents');
if (! container) 
return;



container.innerHTML = ranking.map(a => `<div class="ranking-item d-flex p-2 border rounded mb-2"><div class="agent-avatar me-2">${
a.avatar
}</div><div class="flex-1"><h6>${
a.name
}</h6></div></div>`).join('');
},

loadQualificationStats() {
const canvas = document.getElementById('qualification-chart');
if (! canvas) 
return;



new Chart(canvas.getContext('2d'), {
type: 'line',
data: {
labels: [
'L',
'M',
'M',
'J',
'V',
'S',
'D'
],
datasets: [
{
data: [
85,
88,
82,
90,
87,
92,
86
],
borderColor: '#3b82f6'
}
]
},
options: {
responsive: true,
maintainAspectRatio: false
}
});
},

loadSupervisorCampaigns() {
const campaigns = [{
name: 'Vente Printemps',
progress: 75,
agents: 5,
status: 'active'
}];
const container = document.getElementById('supervisor-campaigns');
if (! container) 
return;



container.innerHTML = campaigns.map(c => `<div class="campaign-card p-3 border rounded mb-2"><h6>${
c.name
}</h6><div class="progress h-2 mb-2"><div class="progress-bar" style="width:${
c.progress
}%"></div></div></div>`).join('');
},

applyAgentView() {
document.querySelectorAll('.restricted-responsable').forEach(el => el.classList.add('hidden'));
document.querySelectorAll('.nav-item').forEach(item => {
const oc = item.getAttribute('onclick');
if (oc && (oc.includes('users') || oc.includes('campaigns'))) 
item.style.display = 'none';
 else 
item.style.display = 'flex';



});
},

applyAdminView() {
if (this.userData.roles.includes('ROLE_RESPONSABLE')) 
document.querySelectorAll('.restricted-responsable').forEach(el => el.classList.remove('hidden'));



document.querySelectorAll('.nav-item').forEach(item => item.style.display = 'flex');
},

async initializeAgentDashboard() {
    this.showLoader(true);
    try {
        const res = await fetch('/api/agent/stats', {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        const stats = await res.json();

        this.animateCounter('agent-stat-calls', stats.callsToday || 0);
        this.animateCounter('agent-stat-qualification', stats.qualificationRate || 0, '%');
        
        const durationEl = document.getElementById('agent-stat-duration');
        if (durationEl) durationEl.innerText = (stats.avgDuration || 0) + 's';
        
        const scoreEl = document.getElementById('agent-stat-score');
        if (scoreEl) scoreEl.innerText = stats.score || 0;

        const cp = document.getElementById('agent-calls-progress-bar');
        if (cp) cp.style.width = (stats.callsProgress || 0) + '%';
        
        const qp = document.getElementById('agent-qualification-progress-bar');
        if (qp) qp.style.width = (stats.qualificationRate || 0) + '%';

        await this.loadAgentCampaigns();
        await this.loadAgentActivity();
        await this.loadAgentAlerts();
    } catch (err) {
        console.error("Agent Dashboard Error:", err);
    } finally {
        this.showLoader(false);
    }
},

async loadAgentCampaigns() {
    try {
        const res = await fetch('/api/agent/campaigns', {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        const campaigns = await res.json();
        const container = document.getElementById('agent-campaigns');
        if (!container) return;

        container.innerHTML = campaigns.length ? campaigns.map(c => `
            <div class="card mb-3 border-0 bg-gray-50 dark:bg-gray-700 hover:shadow-md transition-all cursor-pointer" onclick="App.selectAgentCampaign(${c.id})">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 fw-bold">${c.nom}</h6>
                        <span class="badge bg-primary bg-opacity-10 text-primary">${c.progress || 0}%</span>
                    </div>
                    <div class="progress h-1 mb-2">
                        <div class="progress-bar bg-primary" style="width: ${c.progress || 0}%"></div>
                    </div>
                    <small class="text-gray-500">${c.contacts_remaining || 0} contacts restants</small>
                </div>
            </div>
        `).join('') : '<p class="text-center py-4 text-gray-500">Aucune campagne assign√©e</p>';
    } catch (err) { console.error(err); }
},

async loadAgentActivity() {
    // For now we could use a generic activity log or just mock if no endpoint exists
    const acts = [
        { title: 'Appel termin√©', details: 'Client Dupont - 3:45', color: 'primary' },
        { title: 'Qualification soumise', details: 'Accept√© - Campagne Vente', color: 'success' }
    ];
    const container = document.getElementById('agent-activity-log');
    if (!container) return;

    container.innerHTML = acts.map(a => `
        <div class="d-flex align-items-center p-3 mb-2 bg-gray-50 dark:bg-gray-700 rounded-xl">
            <div class="icon-box bg-${a.color} bg-opacity-10 text-${a.color} rounded-lg p-2 me-3">
                <i class="fas fa-history"></i>
            </div>
            <div>
                <h6 class="mb-0 fw-semibold">${a.title}</h6>
                <small class="text-gray-500">${a.details}</small>
            </div>
        </div>
    `).join('');
},

async loadAgentAlerts() {
    try {
        const res = await fetch('/api/agent/alerts', {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        const alerts = await res.json();
        const container = document.getElementById('agent-alerts');
        if (!container) return;

        document.getElementById('alert-count').innerText = alerts.length;
        container.innerHTML = alerts.length ? alerts.map(a => `
            <div class="alert alert-${a.type === 'danger' ? 'danger' : 'warning'} border-0 shadow-sm rounded-xl mb-2 d-flex align-items-center">
                <i class="fas fa-exclamation-circle me-2"></i>
                <div class="flex-grow-1">
                    <p class="mb-0 small fw-bold">${a.message}</p>
                    <small class="opacity-75">${a.time}</small>
                </div>
            </div>
        `).join('') : '<p class="text-center py-3 text-gray-400 small">Aucune alerte</p>';
    } catch (err) { console.error(err); }
},

async selectAgentCampaign(id) {
    this.showLoader(true);
    try {
        this.currentCampaignId = id;
        console.log("Selected campaign:", id);
        this.addActivity("Campagne s√©lectionn√©e ID: " + id);
        
        const nc = document.getElementById('next-call');
        if (nc) {
            nc.innerHTML = `<div class="text-center py-3">
                <i class="fas fa-bullseye text-4xl text-primary mb-3"></i>
                <h6>Pr√™t pour la campagne #${id}</h6>
                <p class="text-gray-500 small mb-3">Cliquez pour chercher un contact</p>
                <button class="btn-glow w-100" onclick="App.launchNextCall(${id})">
                    <i class="fas fa-search me-2"></i>Chercher un contact
                </button>
            </div>`;
        }
    } catch (err) { console.error(err); }
    finally { this.showLoader(false); }
},

async launchNextCall(campaignId = null) {
    const cid = campaignId || this.currentCampaignId;
    if (!cid) return alert("Veuillez d'abord s√©lectionner une campagne.");

    const nc = document.getElementById('next-call');
    if (!nc) return;

    nc.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h6>Recherche du prochain contact...</h6>
        </div>
    `;

    try {
        const res = await fetch(`/api/agent/next-contact/${cid}`, {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        if (!res.ok) throw new Error("Plus de contacts disponibles");
        
        this.currentContact = await res.json();
        
        // Simulate dialing and auto-trigger softphone
        setTimeout(() => {
            this.startCallTimer();
            
            // Auto-trigger softphone (MicroSIP/System default)
            window.location.href = `tel:${this.currentContact.telephone}`;
            
            nc.innerHTML = `
                <div class="text-center py-3 animate-fade-in">
                    <div class="call-timer mb-3" id="active-call-timer">00:00</div>
                    <i class="fas fa-phone-volume text-success mb-3 animate-pulse" style="font-size: 2.5rem;"></i>
                    <h6 class="fw-bold text-uppercase tracking-wider">APPEL EN COURS</h6>
                    <div class="d-flex align-items-center justify-content-center gap-3 mb-1">
                        <p class="text-primary fw-bold mb-0" style="font-size: 1.5rem;">${this.currentContact.telephone}</p>
                        <div class="btn-group">
                            <a href="tel:${this.currentContact.telephone}" class="btn btn-sm btn-outline-success" title="MicroSIP">
                                <i class="fas fa-phone"></i>
                            </a>
                            <a href="callto:${this.currentContact.telephone}" class="btn btn-sm btn-outline-info" title="Zoiper">
                                <i class="fas fa-headset"></i>
                            </a>
                        </div>
                    </div>
                    <p class="text-gray-500 small mb-4">${this.currentContact.nom}</p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-danger w-100 py-3 rounded-xl shadow-lg" onclick="App.endCall()">
                            <i class="fas fa-phone-slash me-2"></i>Raccrocher
                        </button>
                    </div>
                </div>
            `;
        }, 1500);
    } catch (err) {
        nc.innerHTML = `<p class="text-danger text-center p-3">${err.message}</p>`;
    }
},

startCallTimer() {
    this.callSeconds = 0;
    if (this.callInterval) clearInterval(this.callInterval);
    this.callInterval = setInterval(() => {
        this.callSeconds++;
        const timerEl = document.getElementById('active-call-timer');
        if (timerEl) {
            const m = Math.floor(this.callSeconds / 60).toString().padStart(2, '0');
            const s = (this.callSeconds % 60).toString().padStart(2, '0');
            timerEl.innerText = `${m}:${s}`;
        }
    }, 1000);
},

async endCall() {
    if (this.callInterval) clearInterval(this.callInterval);
    const duration = this.callSeconds;
    
    const nc = document.getElementById('next-call');
    if (!nc) return;

    nc.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 small">Chargement du formulaire...</p>
        </div>
    `;

    try {
        const res = await fetch(`/api/agent/campaigns/${this.currentCampaignId}/fields`, {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        const fields = await res.json();

        nc.innerHTML = `
            <div class="qualification-form text-start animate-fade-in">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0">QUALIFICATION</h6>
                    <span class="badge bg-gray-100 text-gray-600">${duration}s</span>
                </div>
                
                <div class="form-group mb-3">
                    <label class="small fw-bold text-gray-500">R√âSULTAT DE L'APPEL</label>
                    <select id="call-status" class="form-select border-0 bg-gray-50 rounded-xl py-2">
                        <option value="was_reached">Joignable / Argument√©</option>
                        <option value="busy">Occup√©</option>
                        <option value="no_answer">Pas de r√©ponse</option>
                        <option value="wrong_number">Faux num√©ro</option>
                        <option value="refused">Refus cat√©gorique</option>
                    </select>
                </div>

                <div id="dynamic-fields-area">
                    ${fields.map(f => `
                        <div class="form-group mb-3">
                            <label class="small fw-bold text-gray-500">${f.label.toUpperCase()}</label>
                            ${f.type === 'textarea' ? 
                                `<textarea class="form-control border-0 bg-gray-50 rounded-xl" id="field-${f.id}" rows="2"></textarea>` :
                                `<input type="${f.type}" class="form-control border-0 bg-gray-50 rounded-xl py-2" id="field-${f.id}">`
                            }
                        </div>
                    `).join('')}
                </div>

                <button class="btn btn-primary w-100 py-2 rounded-xl mt-2" onclick="App.submitQualification()">
                    <i class="fas fa-check me-2"></i>Valider & Continuer
                </button>
            </div>
        `;
    } catch (err) {
        console.error(err);
        nc.innerHTML = `<p class="text-danger">Erreur chargement formulaire</p>`;
    }
},

async submitQualification() {
    this.showLoader(true);
    try {
        // Collect data
        const status = document.getElementById('call-status').value;
        const responses = {};
        document.querySelectorAll('[id^="field-"]').forEach(el => {
            responses[el.id.replace('field-', '')] = el.value;
        });

        console.log("Submitting qualification:", { status, responses });
        
        // In reality, send to API
        // const res = await fetch('/api/agent/qualify', { ... });

                this.showAlert("Appel qualifi√© avec succ√®s");
        this.addActivity("Qualification termin√©e: " + status);
        
        const nc = document.getElementById('next-call');
        if (nc) {
            nc.innerHTML = `
                <div class="text-center py-4 animate-fade-in">
                    <div class="icon-box bg-success bg-opacity-10 text-success rounded-circle p-3 d-inline-block mb-3">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                    <h6 class="fw-bold">Contact qualifi√© !</h6>
                    <p class="text-gray-500 small mb-4">Mise √† jour de vos statistiques...</p>
                    <button class="btn btn-primary w-100 py-3 rounded-xl" onclick="App.launchNextCall()">
                        <i class="fas fa-forward me-2"></i>Appel Suivant
                    </button>
                </div>
            `;
        }
        
        // Refresh stats
        this.initializeAgentDashboard();
        
    } catch (err) { alert(err.message); }
    finally { this.showLoader(false); }
},

async refreshAgentCampaigns() {
    this.addActivity("Actualisation des campagnes...");
    await this.loadAgentCampaigns();
},

filterAgentActivity(type) {
    console.log("Filtering agent activity by:", type);
    // Simple refresh for now as activities are mocked
    this.loadAgentActivity();
}
};

const UI = {
    showManualDialer() {
        const c = document.getElementById('modal-container');
        document.getElementById('modal-title').innerText = "Appel Manuel Direct";
        document.getElementById('modal-body').innerHTML = `
            <div class="text-center mb-4">
                <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-circle p-3 d-inline-block mb-3">
                    <i class="fas fa-phone-alt fa-2x"></i>
                </div>
                <p class="text-gray-500 small">Saisissez un num√©ro pour lancer l'appel via VoIP</p>
            </div>
            <div class="input-group">
                <label class="form-label-caps">Num√©ro de t√©l√©phone</label>
                <input type="text" id="manual-phone" placeholder="06XXXXXXXX" class="text-center h4 py-3" style="letter-spacing: 2px;">
            </div>
            <div class="d-grid gap-2 mt-4" style="grid-template-columns: repeat(2, 1fr);">
                <button class="btn btn-outline-success py-3 rounded-xl" onclick="UI.doManualCall('tel')">
                    <i class="fas fa-phone me-2"></i>MicroSIP
                </button>
                <button class="btn btn-outline-info py-3 rounded-xl" onclick="UI.doManualCall('callto')">
                    <i class="fas fa-headset me-2"></i>Zoiper
                </button>
            </div>
        `;
        document.getElementById('modal-save').classList.add('hidden');
        c.classList.remove('hidden');
    },

    doManualCall(protocol) {
        const phone = document.getElementById('manual-phone').value;
        if (!phone) {
            App.showAlert("Veuillez saisir un num√©ro", "error");
            return;
        }
        App.showAlert("Lancement de l'appel...");
        window.location.href = `${protocol}:${phone}`;
        this.closeModal();
    },

    async deleteCampaign(id) {
if (!confirm("Supprimer ?")) 
return;



App.showLoader(true);
try {
const res = await fetch(`/api/management/campaigns/${id}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
        if (res.ok) {
            App.showAlert("Campagne supprim√©e");
            App.loadCampaigns();
        }
} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async editCampaign(id) {
App.showLoader(true);
try {
const res = await fetch('/api/management/campaigns?t=' + Date.now(), {
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
const camps = await res.json();
const camp = camps.find(c => c.id === parseInt(id));
if (camp) 
this.showCampaignModal(camp);



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

showCampaignModal(data = null) {
    const c = document.getElementById('modal-container');
    document.getElementById('modal-title').innerText = data ? "Modifier la Campagne" : "Lancer une nouvelle Campagne";
    document.getElementById('modal-body').innerHTML = `
        <input type="hidden" id="m-camp-id" value="${data ? data.id : ''}">
        <div class="input-group">
            <label class="form-label-caps">Titre de la campagne</label>
            <input type="text" id="m-camp-nom" value="${data ? data.nom : ''}" placeholder="Ex: Campagne Hiver 2024">
        </div>
        <div class="modal-grid">
            <div class="input-group">
                <label class="form-label-caps">Date de d√©but</label>
                <input type="date" id="m-camp-start" value="${data ? data.date_debut : ''}">
            </div>
            <div class="input-group">
                <label class="form-label-caps">Date de fin</label>
                <input type="date" id="m-camp-end" value="${data ? data.date_fin : ''}">
            </div>
        </div>
    `;
    const s = document.getElementById('modal-save');
    s.innerHTML = '<i class="fas fa-save me-2"></i>' + (data ? "Enregistrer" : "Cr√©er la campagne");
    s.onclick = () => this.saveCampaign(data ? 'PUT' : 'POST');
    c.classList.remove('hidden');
},

async saveCampaign(method) {
const payload = {
nom: document.getElementById('m-camp-nom').value,
date_debut: document.getElementById('m-camp-start').value,
date_fin: document.getElementById('m-camp-end').value
};
const id = document.getElementById('m-camp-id').value;
const url = method === 'PUT' ? `/api/management/campaigns/${id}` : '/api/management/campaigns';
App.showLoader(true);
try {
const res = await fetch(url, {
method,
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${
App.token
}`
},
body: JSON.stringify(payload)
});
        if (res.ok) {
            App.showAlert(method === 'POST' ? "Campagne cr√©√©e avec succ√®s" : "Campagne mise √† jour");
            this.closeModal();
            App.loadCampaigns();
        }
    } catch (err) {
        App.showAlert(err.message, 'error');
    } finally {
App.showLoader(false);
}
},

closeModal() {
    document.getElementById('modal-container').classList.add('hidden');
    document.getElementById('modal-save').classList.remove('hidden');
},

showUserModal(data = null) {
    const c = document.getElementById('modal-container');
    document.getElementById('modal-title').innerText = data ? "Modifier le Membre" : "Ajouter un Membre";
    document.getElementById('modal-body').innerHTML = `
        <input type="hidden" id="m-user-id" value="${data ? data.id : ''}">
        <div class="modal-grid">
            <div class="input-group">
                <label class="form-label-caps">Pr√©nom</label>
                <input type="text" id="m-user-prenom" value="${data ? data.prenom : ''}" placeholder="Pr√©nom">
            </div>
            <div class="input-group">
                <label class="form-label-caps">Nom</label>
                <input type="text" id="m-user-nom" value="${data ? data.nom || '' : ''}" placeholder="Nom">
            </div>
        </div>
        <div class="input-group">
            <label class="form-label-caps">Email professionnel</label>
            <input type="email" id="m-user-email" value="${data ? data.email : ''}" placeholder="email@zanova.com">
        </div>
        <div class="modal-grid">
            <div class="input-group">
                <label class="form-label-caps">R√¥le CRM</label>
                <select id="m-user-role" class="modal-select">
                    <option value="agent" ${data && data.role === 'agent' ? 'selected' : ''}>Agent</option>
                    <option value="superviseur" ${data && data.role === 'superviseur' ? 'selected' : ''}>Superviseur</option>
                    <option value="responsable" ${data && data.role === 'responsable' ? 'selected' : ''}>Responsable / Admin</option>
                </select>
            </div>
            <div class="input-group">
                <label class="form-label-caps">Mot de passe ${data ? '(Optionnel)' : ''}</label>
                <input type="password" id="m-user-pass" placeholder="${data ? 'Laisser vide pour ne pas changer' : 'Minimum 6 caract√®res'}">
            </div>
        </div>
    `;
    const s = document.getElementById('modal-save');
    s.innerHTML = '<i class="fas fa-check me-2"></i>' + (data ? "Mettre √† jour" : "Cr√©er le compte");
    s.onclick = () => this.saveUser(data ? 'PUT' : 'POST');
    c.classList.remove('hidden');
},

async saveUser(method) {
    const id = document.getElementById('m-user-id').value;
    const payload = {
        prenom: document.getElementById('m-user-prenom').value,
        nom: document.getElementById('m-user-nom').value,
        email: document.getElementById('m-user-email').value,
        role: document.getElementById('m-user-role').value,
        password: document.getElementById('m-user-pass').value
    };
    if (method === 'POST' && !payload.password) {
        alert("Veuillez saisir un mot de passe pour le nouveau membre.");
        return;
    }
App.showLoader(true);
try {
const res = await fetch(method === 'PUT' ? `/api/management/users/${id}` : '/api/management/users', {
method,
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${
App.token
}`
},
body: JSON.stringify(payload)
});
        if (res.ok) {
            App.showAlert(method === 'POST' ? "Membre ajout√© avec succ√®s" : "Profil mis √† jour");
            this.closeModal();
            App.loadUsers();
        }
    } catch (err) {
        App.showAlert(err.message, 'error');
    } finally {
App.showLoader(false);
}
},

async editUser(id) {
App.showLoader(true);
try {
const res = await fetch('/api/management/users', {
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
const users = await res.json();
const u = users.find(u => u.id === parseInt(id));
if (u) 
this.showUserModal(u);



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async manageFields(cid) {
    App.showLoader(true);
    try {
        const res = await fetch(`/api/management/campaigns/${cid}/fields`, {
            headers: { 'Authorization': `Bearer ${App.token}` }
        });
        const fields = await res.json();
        document.getElementById('modal-title').innerText = "Configuration du Formulaire";
        document.getElementById('modal-body').innerHTML = `
            <div class="assignment-list">
                ${fields.length ? fields.map(f => `
                    <div class="assignment-item">
                        <div class="assignment-info">
                            <div class="icon-box bg-primary bg-opacity-10 text-primary p-2 rounded">
                                <i class="fas fa-edit small"></i>
                            </div>
                            <strong>${f.label}</strong>
                            <span class="badge badge-neutral">${f.type}</span>
                        </div>
                        <button class="btn-action delete" onclick="UI.deleteField(${f.id}, ${cid})" title="Supprimer">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('') : '<div class="empty-state">Aucun champ configur√©</div>'}
            </div>
            
            <div class="modal-action-bar">
                <div class="input-group flex-grow-1 mb-0">
                    <label class="form-label-caps">Nouveau champ</label>
                    <div class="d-flex gap-2">
                        <input id="new-field-label" placeholder="Libell√© du champ..." style="padding: 0.8rem;">
                        <button class="btn-glow" onclick="UI.addField(${cid})" style="padding: 0.8rem 1.2rem;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('modal-save').classList.add('hidden');
        document.getElementById('modal-container').classList.remove('hidden');
    } catch (err) {
        alert(err.message);
    } finally {
        App.showLoader(false);
    }
},

async addField(cid) {
const label = document.getElementById('new-field-label').value;
App.showLoader(true);
try {
const res = await fetch(`/api/management/campaigns/${cid}/fields`, {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${
App.token
}`
},
body: JSON.stringify(
{label, type: 'text'}
)
});
        if (res.ok) {
            App.showAlert("Champ ajout√©");
            this.manageFields(cid);
        }



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async deleteField(fid, cid) {
App.showLoader(true);
try {
const res = await fetch(`/api/management/fields/${fid}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
        if (res.ok) {
            App.showAlert("Champ supprim√©");
            this.manageFields(cid);
        }



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async manageAssignments(cid) {
    App.showLoader(true);
    try {
        const resA = await fetch(`/api/management/campaigns/${cid}/users`, {
            headers: { 'Authorization': `Bearer ${App.token}` }
        });
        const ass = await resA.json();
        const resU = await fetch('/api/management/users', {
            headers: { 'Authorization': `Bearer ${App.token}` }
        });
        const users = await resU.json();
        
        document.getElementById('modal-title').innerText = "Affectation des Agents";
        document.getElementById('modal-body').innerHTML = `
            <div class="assignment-list">
                ${ass.length ? ass.map(a => `
                    <div class="assignment-item">
                        <div class="assignment-info">
                            <div class="user-avatar" style="width:30px; height:30px; font-size:0.7rem;">${a.prenom ? a.prenom[0] : '?'}</div>
                            <strong>${a.prenom} ${a.nom}</strong>
                        </div>
                        <button class="btn-action delete" onclick="UI.unassignUser(${a.id}, ${cid})" title="Retirer">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('') : '<div class="empty-state">Aucun agent sur cette campagne</div>'}
            </div>
            
            <div class="input-group">
                <label class="form-label-caps">Ajouter un membre</label>
                <div class="d-flex gap-2">
                    <select id="assign-user-select" class="modal-select" style="padding: 0.8rem;">
                        ${users.map(u => `<option value="${u.id}">${u.prenom} ${u.nom} (${u.role})</option>`).join('')}
                    </select>
                    <button class="btn-glow" onclick="UI.doAssign(${cid})" style="padding: 0.8rem 1.2rem;">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `;
        document.getElementById('modal-save').classList.add('hidden');
        document.getElementById('modal-container').classList.remove('hidden');
    } catch (err) { alert(err.message); }
    finally { App.showLoader(false); }
},

async manageUserAssignments(uid) {
    App.showLoader(true);
    try {
        const resC = await fetch('/api/management/campaigns', {
            headers: { 'Authorization': `Bearer ${App.token}` }
        });
        const campaigns = await resC.json();
        
        // Fetch current assignments for this user
        const resA = await fetch('/api/management/assignments', { // Need to ensure this endpoint exists or filter manually
             headers: { 'Authorization': `Bearer ${App.token}` }
        });
        const allAss = await resA.json();
        const userAss = allAss.filter(a => a.user_id === uid);

        document.getElementById('modal-title').innerText = "Campagnes affect√©es";
        document.getElementById('modal-body').innerHTML = `
            <div class="assignment-list">
                ${userAss.length ? userAss.map(a => {
                    const campaign = campaigns.find(c => c.id === a.campaign_id);
                    return `
                        <div class="assignment-item">
                            <div class="assignment-info">
                                <div class="icon-box bg-primary bg-opacity-10 text-primary p-2 rounded">
                                    <i class="fas fa-bullseye small"></i>
                                </div>
                                <strong>${campaign ? campaign.nom : 'Campagne #' + a.campaign_id}</strong>
                            </div>
                            <button class="btn-action delete" onclick="UI.unassignUser(${a.id}, null, ${uid})" title="R√©voquer">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }).join('') : '<div class="empty-state">Aucune campagne affect√©e</div>'}
            </div>
            
            <div class="input-group">
                <label class="form-label-caps">Affecter √† une nouvelle campagne</label>
                <div class="d-flex gap-2">
                    <select id="assign-camp-select" class="modal-select" style="padding: 0.8rem;">
                        ${campaigns.map(c => `<option value="${c.id}">${c.nom}</option>`).join('')}
                    </select>
                    <button class="btn-glow" onclick="UI.doAssignUserToCamp(${uid})" style="padding: 0.8rem 1.2rem;">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `;
        document.getElementById('modal-save').classList.add('hidden');
        document.getElementById('modal-container').classList.remove('hidden');
    } catch (err) { alert(err.message); }
    finally { App.showLoader(false); }
},

async doAssignUserToCamp(uid) {
    const cid = document.getElementById('assign-camp-select').value;
    App.showLoader(true);
    try {
        const res = await fetch(`/api/management/campaigns/${cid}/assign/${uid}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${App.token}` }
        });
                if (res.ok) {
            App.showAlert("Campagne affect√©e");
            this.manageUserAssignments(uid);
        }
    } catch (err) { alert(err.message); }
    finally { App.showLoader(false); }
},

async doAssign(cid) {
const uid = document.getElementById('assign-user-select').value;
App.showLoader(true);
try {
const res = await fetch(`/api/management/campaigns/${cid}/assign/${uid}`, {
method: 'POST',
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
        if (res.ok) {
            App.showAlert("Agent affect√© avec succ√®s");
            this.manageAssignments(cid);
        }



} catch (err) {
alert(err.message);
} finally {
App.showLoader(false);
}
},

async unassignUser(aid, cid = null, uid = null) {
    if (!confirm("Voulez-vous r√©voquer cette affectation ?")) return;
    App.showLoader(true);
    try {
        const res = await fetch(`/api/management/assignments/${aid}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${App.token}` }
        });
                if (res.ok) {
            App.showAlert("Affectation r√©voqu√©e");
            if (cid) this.manageAssignments(cid);
            else if (uid) this.manageUserAssignments(uid);
        }
    } catch (err) { alert(err.message); }
    finally { App.showLoader(false); }
},

async deleteUser(id) {
if (!confirm("Supprimer ?")) 
return;



App.showLoader(true);
try {
const res = await fetch(`/api/management/users/${id}`, {
method: 'DELETE',
headers: {
'Authorization': `Bearer ${
App.token
}`
}
});
        if (res.ok) {
            App.showAlert("Membre supprim√©");
            App.loadUsers();
        }



} catch (err) {
    App.showAlert(err.message, 'error');
} finally {
App.showLoader(false);
}
}
};


document.addEventListener('DOMContentLoaded', () => {
console.log("App: DOM fully loaded, initializing...");
App.init();
});
</script>
